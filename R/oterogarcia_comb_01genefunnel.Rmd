---
title: "Otero-Garcia - Comb - 01 GeneFunnel"
author:
  - name: "Emir Turkes"
date: '`r strftime(Sys.time(), format = "%B %d, %Y")`'
link-citations: true
output:
  html_document:
    code_folding: hide
    number_sections: true
    theme: lumen
    highlight: haddock
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: false
knit: (function(inputFile, encoding) {
  rmarkdown::render(
    inputFile, encoding = encoding,
    output_file = file.path("..", "results", "oterogarcia_comb_01genefunnel.html")
  )})
---

<style type="text/css">
body {font-size: 16px;}
h1.title {font-size: 35px;}
h1 {font-size: 24px;}
h2 {font-size: 22px;}
h3 {font-size: 20px;}
.toc-content {padding-left: 0px; padding-right: 0px;}
div.tocify {width: 100%;}
.tocify-subheader .tocify-item {font-size: 0.95em; padding-left: 25px; text-indent: 0;}
.tocify-subheader .tocify-subheader .tocify-item {font-size: 0.95em; padding-left: 35px; text-indent: 0;}
div.main-container {max-width: none; width: 100%;}
</style>

*This file is a part of [tau-mutant-omics-analysis](https://github.com/eturkes/tau-mutant-omics-analysis).*

The table of contents in the top left is clickable and can be used to quickly navigate the document.
To toggle the visibility of code, use the `CODE` toggles at the top right of chunks.
The toggle at the start of the document controls the visibility of all chunks.

```{r}
#    This file is part of tau-mutant-omics-analysis.
#    Copyright (C) 2023-2024  Emir Turkes, Naoto Watamura, UK DRI at UCL
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#    Emir Turkes can be contacted at emir.turkes@eturkes.com

# Load required packages, suppressing startup messages.
# -----------------------------------------------------
library(conflicted)
conflicts_prefer(AnnotationDbi::select, edgeR::cpm, DT::JS, base::intersect, reshape2::melt, .quiet = TRUE)
packages <- c(
  "GSEABase", "Seurat", "ggplot2", "dplyr", "ggrepel", "scuttle", "GO.db", "tm", "pals", "ComplexHeatmap", "edgeR",
  "DT", "circlize", "purrr", "networkD3", "factoextra", "reshape2", "dendextend", "data.table", "scales", "igraph",
  "qgraph", "multienrichjam", "GSVA"
)
invisible(suppressPackageStartupMessages(lapply(packages, FUN = library, character.only = TRUE)))
# -----------------------------------------------------

# Define global settings.
# -----------------------
knitr::opts_chunk$set(fig.width = 10, fig.height = 7, dpi = 300)
# -----------------------

# Define functions.
# -----------------
source("utils.R")

`%notin%` <- Negate(`%in%`)
# -----------------

# Useful variables.
# -----------------
sample <- "oterogarcia"
batch <- "comb"
step <- 1

results_dir <- file.path("..", "results")
cache_dir <- file.path("..", "cache", sample, batch, paste0("0", step))
if (!dir.exists(cache_dir)) {
  dir.create(cache_dir, recursive = TRUE)
}
# -----------------

# Useful data.
# ------------
gene_anno <- readRDS(file.path("..", "cache", "oterogarcia", "01", "02", "gene_anno.rds"))
gene_sets <- readRDS(file.path("..", "cache", "filtered_gene_sets_hsapiens.rds"))
# ------------
```

# Merging

```{r}
gse <- counts(readRDS(file.path(cache_dir, "..", "..", "..", "oterogarcia/01/02/pseudobulk_gse.rds")))
counts <- counts(readRDS(file.path(cache_dir, "..", "..", "..", "oterogarcia/01/02/pseudobulk_counts.rds")))
```

# Analysis

```{r}
colour <- colorRamp2(c(-3, 0, 3), c("#0077BB", "#FFFFFF", "#CC3311"))
module_colors <- cols25(25)

# keep <- filterGeneSets(gene_sets, min.sz = 5, max.sz = 25)
# gene_sets <- gene_sets[names(gene_sets) %in% names(keep)]
# 
# gse <- gse[rownames(gse) %in% names(gene_sets), ]
# gene_anno <- gene_anno[gene_anno$ensembl_gene_id %in% unique(unlist(geneIds(gene_sets))), ]
# counts <- counts[rownames(counts) %in% gene_anno$ensembl_gene_id, ]
```

# GSE

## BA9 EX Neurons

```{r, fig.width = 8, fig.height = 6, dpi = 72}
ctype <- "BA9 EX Neurons"

groups <- factor(
  sub(".*?(\\w+)-\\w+$", "\\1", colnames(gse)),
  levels = unique(sub(".*?(\\w+)-\\w+$", "\\1", colnames(gse)))
)
design <- model.matrix(~ 0 + groups)
colnames(design) <- unique(groups)

keep <- filterByExpr(gse, group = groups, min.total.count = 1000, min.count = 1000)
gse_filt <- gse[keep, ]

keep <- filterByExpr(counts, group = groups, min.total.count = 100, min.count = 100)
counts_filt <- counts[keep, ]

gse_cpm <- log1p(cpm(gse_filt))
counts_cpm <- log1p(cpm(counts_filt))

fit <- lmFit(gse_cpm, design)
cont_mat <- makeContrasts(MAP2-AT8, levels = design)
cont_fit <- eBayes(contrasts.fit(fit, cont_mat), trend = TRUE)
tests <- decideTests(cont_fit, "global")
write.fit(
  cont_fit, tests, file.path(cache_dir, "results.tsv"),
  adjust = "BH", method = "global", F.adjust = "BH"
)
results <- read.delim(file.path(cache_dir, "results.tsv"))
rownames(results) <- results$X
results <- results[ , -1]
results <- results[results$P.value.adj < 0.05, ]

# keep <- rownames(gse_cpm[rowSums(gse_cpm > 0) >= 1, ])
# gse_zscore <- t(scale(t(gse_cpm[keep, ])))
# keep <- rownames(counts_cpm[rowSums(counts_cpm > 0) >= 1, ])
# counts_zscore <- t(scale(t(counts_cpm[keep, ])))

markers <- data.frame(cluster = character(), gene = character())
group_idx <- vector("list", length = length(groups))
group_idx[[1]] <- 1:8
group_idx[[2]] <- 9:16

for (i in seq_along(unique(groups))) {
  if (i == 1) {
    gene <- rownames(results)[results$Coef > 0]
    avg_log2FC <- results$Coef[results$Coef > 0]
  } else {
    gene <- rownames(results)[results$Coef < -0]
    avg_log2FC <- abs(results$Coef)[results$Coef < -0]
  }
  add <- data.frame(
    cluster = rep(levels(groups)[i], times = length(gene)),
    gene = gene, avg_log2FC = avg_log2FC
  )
  markers <- rbind(markers, add)
}
markers$cluster <- factor(markers$cluster, levels = unique(markers$cluster))
# markers$number <- seq(markers$gene)

# gene_sets_sub <- gene_sets[names(gene_sets) %in% markers$gene]
# gene_set_overlap <- computeGeneSetsOverlapMax(gene_sets_sub, uniqGenes = unique(unlist(geneIds(gene_sets_sub))))
# clustering <- hclust(get_dist(gene_set_overlap, "spearman"), method = "ward.D2")

fit <- lmFit(counts_cpm, design)
cont_mat <- makeContrasts(MAP2-AT8, levels = design)
cont_fit <- eBayes(contrasts.fit(fit, cont_mat), trend = TRUE)
tests <- decideTests(cont_fit, "global")
write.fit(
  cont_fit, tests, file.path(cache_dir, "results.tsv"),
  adjust = "BH", method = "global", F.adjust = "BH"
)
results <- read.delim(file.path(cache_dir, "results.tsv"))
rownames(results) <- results$X
results <- results[ , -1]
results_sig <- results[results$P.value.adj < 0.05, ]
results_left <- results[results$Coef > 0, ]
results_right <- results[results$Coef < -0, ]
results_list <- list(results_left, results_right)

avg_log2FC_all <- results$Coef
names(avg_log2FC_all) <- rownames(results)
avg_log2FC_all_scaled <- (avg_log2FC_all - min(avg_log2FC_all)) / (max(avg_log2FC_all) - min(avg_log2FC_all))
avg_log2FC_all_scaled_rev <- (avg_log2FC_all - max(avg_log2FC_all)) / (min(avg_log2FC_all) - max(avg_log2FC_all))

avg_log2FC_left <- results_left$Coef
names(avg_log2FC_left) <- rownames(results_left)
avg_log2FC_left_scaled <- (avg_log2FC_left - min(avg_log2FC_left)) / (max(avg_log2FC_left) - min(avg_log2FC_left))
avg_log2FC_right <- results_right$Coef
names(avg_log2FC_right) <- rownames(results_right)
avg_log2FC_right_scaled <- (avg_log2FC_right - max(avg_log2FC_right)) / (min(avg_log2FC_right) - max(avg_log2FC_right))

module_direction <- vector("list", length = length(levels(groups)))
module_direction[[1]] <- markers$gene[markers$cluster == levels(groups)[1]]
module_direction[[2]] <- markers$gene[markers$cluster == levels(groups)[2]]

for (i in seq_along(levels(groups))) {
  gene_sets_sub <- gene_sets[names(gene_sets) %in% module_direction[[i]]]
  discard <- computeGeneSetsOverlapMax(gene_sets_sub, uniqGenes = unique(unlist(geneIds(gene_sets_sub))))
  # discard[upper.tri(discard)] <- 0
  # diag(discard) <- 0
  # discard <- colnames(discard)[colSums(discard) == 0]
  discard <- colnames(discard)[colSums(discard) <= 1]
  discard <- which(markers$gene %in% discard)
  if (length(discard) > 0) {
    markers <- markers[-discard, ]
  }
}
module_direction[[1]] <- markers$gene[markers$cluster == levels(groups)[1]]
module_direction[[2]] <- markers$gene[markers$cluster == levels(groups)[2]]

module_gene_sets_sub <- gene_sets[names(gene_sets) %in% module_direction[[1]]]
frequent_genes_tmp <- as.data.frame(table(unlist(geneIds(module_gene_sets_sub))))
frequent_genes_tmp <- frequent_genes_tmp[
  frequent_genes_tmp$Var1 %in% gene_anno$ensembl_gene_id,
]
rownames(frequent_genes_tmp) <- NULL
frequent_genes_left <- frequent_genes_tmp

module_gene_sets_sub <- gene_sets[names(gene_sets) %in% module_direction[[2]]]
frequent_genes_tmp <- as.data.frame(table(unlist(geneIds(module_gene_sets_sub))))
frequent_genes_tmp <- frequent_genes_tmp[
  frequent_genes_tmp$Var1 %in% gene_anno$ensembl_gene_id,
]
rownames(frequent_genes_tmp) <- NULL
frequent_genes_right <- frequent_genes_tmp
frequent_genes <- rbind(frequent_genes_left, frequent_genes_right)

gene_sets_sub <- gene_sets[names(gene_sets) %in% markers$gene]

node_data <- melt(geneIds(gene_sets_sub))
node_data <- node_data[node_data$value %in% frequent_genes$Var1, ]
names(node_data)[1] <- "ensembl_gene_id"
names(node_data)[2] <- "gene_set"
node_data$direction <- ifelse(node_data$gene_set %in% module_direction[[1]], "up", "down")

unique_direction <- as.data.frame.matrix(table(node_data[ , c(1, 3)]), )
unique_direction$down <- unique_direction$down * -1
module_membership_norm <- unique_direction
module_membership_norm <- module_membership_norm[ , c(2, 1)]
# module_membership_norm <- module_membership_norm[abs(rowSums(module_membership_norm)) >= 1, ]

hub_gene_all_GO <- table(unlist(geneIds(gene_sets)))
hub_gene_all_GO <- hub_gene_all_GO[names(hub_gene_all_GO) %in% rownames(module_membership_norm)]

module_membership_norm_calc <-
  (abs(rowSums(module_membership_norm)) / hub_gene_all_GO) * rowSums(module_membership_norm)
module_membership_norm_scaled <-
  (module_membership_norm_calc - min(module_membership_norm_calc)) /
  (max(module_membership_norm_calc) - min(module_membership_norm_calc))

# module_membership_thresh <- vector("numeric", length = length(levels(groups)))
module_membership_thresh <- median(module_membership_norm_calc)
# module_membership_thresh <- summary(as.numeric(module_membership_norm_calc))[5][[1]]

optimal_k <- c()
clustering <- vector("list", length = length(levels(groups)))
for (i in seq_along(levels(groups))) {
  mat <- gse_cpm[rownames(gse_cpm) %in% module_direction[[i]], i, drop = FALSE]
  gene_sets_sub <- gene_sets[names(gene_sets) %in% rownames(mat)]
  gene_set_overlap <- computeGeneSetsOverlapMax(gene_sets_sub, uniqGenes = unique(unlist(geneIds(gene_sets_sub))))
  clustering[[i]] <- hclust(get_dist(gene_set_overlap, "spearman"), method = "ward.D2")

  modules_with_hubs <- vector("list", 26)
  modules_with_hubs[[1]] <- 0
  # modules_with_hubs[[2]] <- 0
  # modules_with_hubs[[3]] <- 0
  # modules_with_hubs[[4]] <- 0
  # modules_with_hubs[[5]] <- 0
  # modules_with_hubs[[6]] <- 0
  # modules_with_hubs[[7]] <- 0
  # modules_with_hubs[[8]] <- 0
  # modules_with_hubs[[9]] <- 0
  for (l in 2:26) {
    set.seed(1)
    heatmap <- Heatmap(
      mat, cluster_rows = clustering[[i]], cluster_columns = FALSE, show_column_names = FALSE,
      show_row_names = FALSE, show_heatmap_legend = FALSE, row_split = l,
    )
    modules <- suppressWarnings(row_order(heatmap))
    hub_gene_list <- vector("list", length(modules))
    for (m in seq_along(modules)) {
      module_sets <- rownames(mat)[modules[[m]]]
      modules_up <- module_sets[module_sets %in% module_direction[[i]]]
      module_hub_genes <- vector()

      if (length(modules_up) == 0) {
      } else {
        module_gene_sets_sub <- gene_sets[names(gene_sets) %in% modules_up]
        frequent_genes <- as.data.frame(table(unlist(geneIds(module_gene_sets_sub))))
        frequent_genes <- frequent_genes[frequent_genes$Var1 %in% rownames(results_list[[i]]), ]

        # results_sub <- results_list[[i]][rownames(results_list[[i]]) %in% frequent_genes$Var1, ]
        # results_sub <- results_sub[match(frequent_genes$Var1, rownames(results_sub)), ]
        # results_sub <- abs(results_sub$Coef)
        # results_sub <- (results_sub - min(results_sub)) / (max(results_sub) - min(results_sub))

        if (i == 1) {
          results_sub <- avg_log2FC_left_scaled[names(avg_log2FC_left_scaled) %in% frequent_genes$Var1]
          results_sub <- results_sub[match(frequent_genes$Var1, names(results_sub))]
        } else {
          results_sub <- avg_log2FC_right_scaled[names(avg_log2FC_right_scaled) %in% frequent_genes$Var1]
          results_sub <- results_sub[match(frequent_genes$Var1, names(results_sub))]
        }

        module_membership_norm_sub <- module_membership_norm[rownames(module_membership_norm) %in% frequent_genes$Var1, ]
        module_membership_norm_sub <- module_membership_norm_sub[
          match(frequent_genes$Var1, rownames(module_membership_norm_sub)),
        ]
        if (i == 1) {
          module_membership_norm_sub$up <- frequent_genes$Freq
        } else {
          module_membership_norm_sub$down <- frequent_genes$Freq * -1
        }

        hub_gene_all_GO_sub <- hub_gene_all_GO[names(hub_gene_all_GO) %in% frequent_genes$Var1]
        # tmp <- (rowSums(module_membership_norm_sub) / hub_gene_all_GO_sub) * abs(rowSums(module_membership_norm_sub))
        # tmp <- (rowSums(module_membership_norm_sub) / hub_gene_all_GO_sub)
        tmp <- (rowSums(module_membership_norm_sub) / length(modules_up))
        # tmp <- (tmp - min(tmp)) / (max(tmp) - min(tmp))

        frequent_genes$Freq <-
          # frequent_genes$Freq *
          tmp
          # (frequent_genes$Freq / nrow(mat))
          # (frequent_genes$Freq / length(modules_up))
          # results_sub

        # frequent_genes <- frequent_genes[frequent_genes$Var1 %in% names(module_membership_norm_calc), ]
        # module_membership_norm_sub <- module_membership_norm_calc[
        #   names(module_membership_norm_calc) %in% frequent_genes$Var1
        # ]
        # module_membership_norm_sub <- module_membership_norm_sub[
        #   match(frequent_genes$Var1, names(module_membership_norm_sub))
        # ]
        # hub_gene_all_GO_sub <- hub_gene_all_GO[names(hub_gene_all_GO) %in% frequent_genes$Var1]
        # hub_gene_all_GO_sub <- hub_gene_all_GO_sub[match(frequent_genes$Var1, names(hub_gene_all_GO_sub))]
        # frequent_genes$Freq <-
          # (frequent_genes$Freq / rowSums(abs(module_membership_norm_sub))) *
          # (frequent_genes$Freq / hub_gene_all_GO_sub) *
          # (frequent_genes$Freq * module_membership_norm_sub) / (length(modules_up) ^ 3) #/ nrow(mat)
          # (frequent_genes$Freq / length(modules_up))
          # (frequent_genes$Freq / nrow(mat))
          # (frequent_genes$Freq / length(modules_up)) *
          # (frequent_genes$Freq / nrow(mat))
          # frequent_genes$Freq /
          #   rowSums(abs(module_membership_norm_sub)) / hub_gene_all_GO_sub / length(modules_up) / nrow(mat)
        # module_membership_norm_tmp <- module_membership_norm_tmp[module_membership_norm_tmp >= module_membership_thresh]
        # module_hub_genes <- names(module_membership_norm_tmp)
        if (i == 1) {
          remove <- which(rowSums(module_membership_norm_sub) <= 0)
          if (length(remove) > 0) {
            frequent_genes <- frequent_genes[-remove, ]
          }
        } else {
          remove <- which(rowSums(module_membership_norm_sub) >= 0)
          if (length(remove) > 0) {
            frequent_genes <- frequent_genes[-remove, ]
          }
        }
        frequent_genes$Freq <- abs(frequent_genes$Freq)
        frequent_genes <- frequent_genes[order(frequent_genes$Freq, decreasing = TRUE), ]
      }

      frequent_genes <- frequent_genes[frequent_genes$Var1 %in% rownames(results_sig), ]
      hub_gene_list[[m]] <- frequent_genes$Freq[1:ceiling(length(modules_up) / 4)]
      hub_gene_list[[m]] <- frequent_genes$Freq
      if (any(is.na(hub_gene_list[[m]]))) {
        hub_gene_list[[m]] <- hub_gene_list[[m]][-which(is.na(hub_gene_list[[m]]))]
      }
    }
    if (any(lengths(hub_gene_list) == 0)) {
      modules_with_hubs[[l]] <- 0
    } else {
      modules_with_hubs[[l]] <- min(unlist(lapply(hub_gene_list, FUN = max)))
      # modules_with_hubs[[l]] <- mean(unlist(hub_gene_list))
    }
  }
  print(plot(unlist(modules_with_hubs)))
  optimal_k <- c(optimal_k, 27 - which.max(rev(modules_with_hubs)))
}
# optimal_k <- c(15, 16)

clustering_left <- color_branches(clustering[[1]], k = optimal_k[1], col = module_colors[seq(optimal_k[1])])
mat_left <- gse_cpm[rownames(gse_cpm) %in% module_direction[[1]], , drop = FALSE]
set.seed(1)
heatmap_left <- Heatmap(
  mat_left, cluster_rows = clustering_left, cluster_columns = FALSE, show_column_names = FALSE,
  show_row_names = TRUE, show_heatmap_legend = FALSE, row_split = optimal_k[1]
)
modules <- suppressWarnings(row_order(heatmap_left))
hub_gene_list_left <- vector("list", length(modules))
hub_gene_list_left_all <- hub_gene_list_left
for (m in seq_along(modules)) {
  module_sets <- rownames(mat_left)[modules[[m]]]
  modules_up <- module_sets[module_sets %in% module_direction[[1]]]
  module_hub_genes <- vector()

  if (length(modules_up) == 0) {
  } else {
    module_gene_sets_sub <- gene_sets[names(gene_sets) %in% modules_up]
    frequent_genes <- as.data.frame(table(unlist(geneIds(module_gene_sets_sub))))
    frequent_genes <- frequent_genes[frequent_genes$Var1 %in% rownames(results_left), ]

    # results_sub <- results_left[rownames(results_left) %in% frequent_genes$Var1, ]
    # results_sub <- results_sub[match(frequent_genes$Var1, rownames(results_sub)), ]
    # results_sub <- abs(results_sub$Coef)
    # results_sub <- (results_sub - min(results_sub)) / (max(results_sub) - min(results_sub))

    results_sub <- avg_log2FC_left_scaled[names(avg_log2FC_left_scaled) %in% frequent_genes$Var1]
    results_sub <- results_sub[match(frequent_genes$Var1, names(results_sub))]
    
    module_membership_norm_sub <- module_membership_norm[rownames(module_membership_norm) %in% frequent_genes$Var1, ]
    module_membership_norm_sub <- module_membership_norm_sub[
      match(frequent_genes$Var1, rownames(module_membership_norm_sub)),
    ]
    module_membership_norm_sub$up <- frequent_genes$Freq

    hub_gene_all_GO_sub <- hub_gene_all_GO[names(hub_gene_all_GO) %in% frequent_genes$Var1]
    # tmp <- (rowSums(module_membership_norm_sub) / hub_gene_all_GO_sub) * abs(rowSums(module_membership_norm_sub))
    tmp <- (rowSums(module_membership_norm_sub) / length(modules_up))
    # tmp <- (tmp - min(tmp)) / (max(tmp) - min(tmp))

    frequent_genes$Freq <-
      # frequent_genes$Freq *
      tmp
      # (frequent_genes$Freq / nrow(mat)) *
      # (frequent_genes$Freq / length(modules_up))
      # results_sub

    # frequent_genes <- frequent_genes[frequent_genes$Var1 %in% names(module_membership_norm_calc), ]
    # module_membership_norm_sub <- module_membership_norm_calc[
    #   names(module_membership_norm_calc) %in% frequent_genes$Var1
    # ]
    # module_membership_norm_sub <- module_membership_norm_sub[
    #   match(frequent_genes$Var1, names(module_membership_norm_sub))
    # ]
    # hub_gene_all_GO_sub <- hub_gene_all_GO[names(hub_gene_all_GO) %in% frequent_genes$Var1]
    # hub_gene_all_GO_sub <- hub_gene_all_GO_sub[match(frequent_genes$Var1, names(hub_gene_all_GO_sub))]
    # frequent_genes$Freq <-
    # (frequent_genes$Freq / rowSums(abs(module_membership_norm_sub))) *
    # (frequent_genes$Freq / hub_gene_all_GO_sub) *
    # (frequent_genes$Freq * module_membership_norm_sub) / (length(modules_up) ^ 3) #/ nrow(mat)
    # (frequent_genes$Freq / length(modules_up))
    # (frequent_genes$Freq / nrow(mat))
    # (frequent_genes$Freq / length(modules_up)) *
    # (frequent_genes$Freq / nrow(mat))
    # frequent_genes$Freq /
    #   rowSums(abs(module_membership_norm_sub)) / hub_gene_all_GO_sub / length(modules_up) / nrow(mat)
    # module_membership_norm_tmp <- module_membership_norm_tmp[module_membership_norm_tmp >= module_membership_thresh]
    # module_hub_genes <- names(module_membership_norm_tmp)
    remove <- which(rowSums(module_membership_norm_sub) <= 0)
    if (length(remove) > 0) {
      frequent_genes <- frequent_genes[-remove, ]
    }
    frequent_genes$Freq <- abs(frequent_genes$Freq)
    frequent_genes <- frequent_genes[order(frequent_genes$Freq, decreasing = TRUE), ]
  }

  hub_gene_list_left_all[[m]] <- frequent_genes
  if (any(is.na(hub_gene_list_left_all[[m]]))) {
    hub_gene_list_left_all[[m]] <- hub_gene_list_left_all[[m]][-which(is.na(hub_gene_list_left_all[[m]]))]
  }

  frequent_genes <- frequent_genes[frequent_genes$Var1 %in% rownames(results_sig), ]
  hub_gene_list_left[[m]] <- as.vector(frequent_genes$Var1)[1:ceiling(length(modules_up) / 4)]
  # hub_gene_list_left[[m]] <- as.vector(frequent_genes$Var1)
  if (any(is.na(hub_gene_list_left[[m]]))) {
    hub_gene_list_left[[m]] <- hub_gene_list_left[[m]][-which(is.na(hub_gene_list_left[[m]]))]
  }
}

clustering_right <- color_branches(
  clustering[[2]], k = optimal_k[2], col = module_colors[seq(optimal_k[2])]
)
mat_right <- gse_cpm[rownames(gse_cpm) %in% module_direction[[2]], , drop = FALSE]
set.seed(1)
heatmap_right <- Heatmap(
  mat_right, cluster_rows = clustering_right, cluster_columns = FALSE, show_column_names = FALSE,
  show_row_names = FALSE, show_heatmap_legend = FALSE, row_split = optimal_k[2]
)
modules <- suppressWarnings(row_order(heatmap_right))
hub_gene_list_right <- vector("list", length(modules))
hub_gene_list_right_all <- hub_gene_list_right
for (m in seq_along(modules)) {
  module_sets <- rownames(mat_right)[modules[[m]]]
  modules_up <- module_sets[module_sets %in% module_direction[[2]]]
  module_hub_genes <- vector()

  if (length(modules_up) == 0) {
  } else {
    module_gene_sets_sub <- gene_sets[names(gene_sets) %in% modules_up]
    frequent_genes <- as.data.frame(table(unlist(geneIds(module_gene_sets_sub))))
    frequent_genes <- frequent_genes[frequent_genes$Var1 %in% rownames(results_right), ]

    # results_sub <- results_right[rownames(results_right) %in% frequent_genes$Var1, ]
    # results_sub <- results_sub[match(frequent_genes$Var1, rownames(results_sub)), ]
    # results_sub <- abs(results_sub$Coef)
    # results_sub <- (results_sub - min(results_sub)) / (max(results_sub) - min(results_sub))

    results_sub <- avg_log2FC_right_scaled[names(avg_log2FC_right_scaled) %in% frequent_genes$Var1]
    results_sub <- results_sub[match(frequent_genes$Var1, names(results_sub))]
    
    module_membership_norm_sub <- module_membership_norm[rownames(module_membership_norm) %in% frequent_genes$Var1, ]
    module_membership_norm_sub <- module_membership_norm_sub[
      match(frequent_genes$Var1, rownames(module_membership_norm_sub)),
    ]
    module_membership_norm_sub$down <- frequent_genes$Freq * -1

    hub_gene_all_GO_sub <- hub_gene_all_GO[names(hub_gene_all_GO) %in% frequent_genes$Var1]
    # tmp <- (rowSums(module_membership_norm_sub) / hub_gene_all_GO_sub) * abs(rowSums(module_membership_norm_sub))
    tmp <- (rowSums(module_membership_norm_sub) / length(modules_up))
    # tmp <- (tmp - min(tmp)) / (max(tmp) - min(tmp))

    frequent_genes$Freq <-
      # frequent_genes$Freq *
      tmp
      # (frequent_genes$Freq / nrow(mat)) *
      # (frequent_genes$Freq / length(modules_up))
      # results_sub

    # frequent_genes <- frequent_genes[frequent_genes$Var1 %in% names(module_membership_norm_calc), ]
    # module_membership_norm_sub <- module_membership_norm_calc[
    #   names(module_membership_norm_calc) %in% frequent_genes$Var1
    # ]
    # module_membership_norm_sub <- module_membership_norm_sub[
    #   match(frequent_genes$Var1, names(module_membership_norm_sub))
    # ]
    # hub_gene_all_GO_sub <- hub_gene_all_GO[names(hub_gene_all_GO) %in% frequent_genes$Var1]
    # hub_gene_all_GO_sub <- hub_gene_all_GO_sub[match(frequent_genes$Var1, names(hub_gene_all_GO_sub))]
    # frequent_genes$Freq <-
    # (frequent_genes$Freq / rowSums(abs(module_membership_norm_sub))) *
    # (frequent_genes$Freq / hub_gene_all_GO_sub) *
    # (frequent_genes$Freq * module_membership_norm_sub) / (length(modules_up) ^ 3) #/ nrow(mat)
    # (frequent_genes$Freq / length(modules_up))
    # (frequent_genes$Freq / nrow(mat))
    # (frequent_genes$Freq / length(modules_up)) *
    # (frequent_genes$Freq / nrow(mat))
    # frequent_genes$Freq /
    #   rowSums(abs(module_membership_norm_sub)) / hub_gene_all_GO_sub / length(modules_up) / nrow(mat)
    # module_membership_norm_tmp <- module_membership_norm_tmp[module_membership_norm_tmp >= module_membership_thresh]
    # module_hub_genes <- names(module_membership_norm_tmp)
    remove <- which(rowSums(module_membership_norm_sub) >= 0)
    if (length(remove) > 0) {
      frequent_genes <- frequent_genes[-remove, ]
    }
    frequent_genes$Freq <- abs(frequent_genes$Freq)
    frequent_genes <- frequent_genes[order(frequent_genes$Freq, decreasing = TRUE), ]
  }

  hub_gene_list_right_all[[m]] <- frequent_genes
  if (any(is.na(hub_gene_list_right_all[[m]]))) {
    hub_gene_list_right_all[[m]] <- hub_gene_list_right_all[[m]][-which(is.na(hub_gene_list_right_all[[m]]))]
  }

  frequent_genes <- frequent_genes[frequent_genes$Var1 %in% rownames(results_sig), ]
  hub_gene_list_right[[m]] <- as.vector(frequent_genes$Var1)[1:ceiling(length(modules_up) / 4)]
  # hub_gene_list_right[[m]] <- as.vector(frequent_genes$Var1)
  if (any(is.na(hub_gene_list_right[[m]]))) {
    hub_gene_list_right[[m]] <- hub_gene_list_right[[m]][-which(is.na(hub_gene_list_right[[m]]))]
  }
}

markers_left <- markers[markers$gene %in% module_direction[[1]], ]
order_left <- suppressWarnings(row_order(heatmap_left))
modules <- order_left
module_names <- modules
names(order_left) <- seq(length(order_left))
markers_tmp <- markers_left[unlist(order_left), ]
markers_tmp$cluster <- unlist(
  lapply(seq_along(order_left), function(i) {rep(names(order_left)[i], length(order_left[[i]]))})
)
markers_tmp <- markers_tmp[match(markers_left$gene, markers_tmp$gene), ]
markers_left$cluster <- factor(markers_tmp$cluster, levels = seq(max(as.numeric(markers_tmp$cluster))))
# markers_left$number <- seq(markers_left$gene)
# markers_left$cluster <- unlist(suppressWarnings(row_order(heatmap_left)))

optimal_k_left <- markers_left$cluster

go_anno <- select(GO.db, markers_left$gene, c("GOID", "TERM", "DEFINITION"), "TERM")
for (l in seq_along(module_names)) {
  module_names[[l]] <- paste0(markers_left$gene[module_names[[l]]], " ", go_anno$DEFINITION[module_names[[l]]])
}
for (l in seq_along(modules)) {
  modules[[l]] <- markers_left$gene[modules[[l]]]
}
top_words_tmp <- data.frame(
  gene_sets = unlist(module_names), module = rep(seq_along(module_names), lapply(module_names, length))
)
top_words_list <- vector("list", length = length(unique(top_words_tmp$module)))
top_words_left <- top_words_list
top_words_left_title <- c()

dict_list <- top_words_list
for (i in seq_along(top_words_list)) {
  top_words_tmp_sub <- top_words_tmp[top_words_tmp$module == i, ]
  top_words_list[[i]] <- vector("list", nrow(top_words_tmp_sub))
  for (j in seq_along(top_words_list[[i]])) {
    top_words_list[[i]][[j]] <- suppressWarnings(word_cloud(top_words_tmp_sub$gene_sets[j]))
  }
  tmp <- strsplit(paste(unlist(top_words_list[[i]]), collapse = " "), "\\s+")[[1]]
  remove <- which(tmp == "")
  if (length(remove) > 0) {
    tmp <- tmp[-which(tmp == "")]
  }
  dict_list[[i]] <- unique(tmp)
}
dict <- table(unlist(dict_list))
dict <- names(dict[dict > ceiling(length(dict_list) / 2)])
# dict <- names(dict[dict > ceiling(sqrt(length(dict_list)))])
# dict <- names(dict[dict == length(dict_list)])
dict <- c()

dict_list <- top_words_list
for (i in seq_along(top_words_list)) {
  top_words_tmp_sub <- top_words_tmp[top_words_tmp$module == i, ]
  top_words_list[[i]] <- vector("list", nrow(top_words_tmp_sub))
  for (j in seq_along(top_words_list[[i]])) {
    top_words_list[[i]][[j]] <- suppressWarnings(word_cloud(top_words_tmp_sub$gene_sets[j], dict = dict))
  }
  tmp <- strsplit(paste(unlist(top_words_list[[i]]), collapse = " "), "\\s+")[[1]]
  remove <- which(tmp == "")
  if (length(remove) > 0) {
    tmp <- tmp[-which(tmp == "")]
  }
  dict_list[[i]] <- unique(tmp)
}

top_words_list_all <- top_words_list
for (i in seq_along(top_words_list)) {
  top_words_tmp_sub <- top_words_tmp[top_words_tmp$module == i, ]
  genes <- gene_sets[names(gene_sets) %in% modules[[i]]]
  genes <- geneIds(genes[match(modules[[i]], names(genes))])
  idx <- colSums(
    sapply(genes, "%in%", x = c(hub_gene_list_left[[i]], NA, NA))
  ) >= ceiling(length(hub_gene_list_left[[i]]) / 4)
  top_words_tmp_sub <- top_words_tmp_sub[idx, ]
  markers_sub <- markers_left[which(markers_left$cluster == levels(markers_left$cluster)[i]), , drop = FALSE]
  markers_sub <- markers_sub[match(modules[[i]], markers_sub$gene), , drop = FALSE]
  markers_sub <- markers_sub[idx, , drop = FALSE]
  modules[[i]] <- modules[[i]][idx]
  top_words_list[[i]] <- vector("list", nrow(top_words_tmp_sub))
  for (j in seq_along(top_words_list[[i]])) {
    top_words_list[[i]][[j]] <- suppressWarnings(word_cloud(top_words_tmp_sub$gene_sets[j], dict = dict))
  }
  tmp <- strsplit(paste(unlist(top_words_list[[i]]), collapse = " "), "\\s+")[[1]]
  remove <- which(tmp == "")
  if (length(remove) > 0) {
    tmp <- tmp[-which(tmp == "")]
  }
  tmp <- table(tmp)
  for (j in seq_along(tmp)) {
    # tmp[j] <- grep(paste0("\\b", names(tmp)[j], "\\b"), unlist(top_words_list[[i]]))
    log2FC <- grep(paste0("\\b", names(tmp)[j], "\\b"), unlist(top_words_list[[i]]))
    tmp[j] <- sum(markers_sub$avg_log2FC[log2FC])
  }
  tmp <- tmp[order(tmp, decreasing = TRUE)]
  remove <- c()
  for (j in seq_along(tmp)) {
    dup <- grep(substr(names(tmp)[j], 1, ceiling(nchar(names(tmp)[j]) / 2)), x = names(tmp))
    if (length(dup) > 1) {
      tmp[dup[1]] <- sum(tmp[dup])
      remove <- c(remove, dup[-1])
    }
  }
  if (length(remove) > 0) {
    tmp <- tmp[-remove]
  }
  tmp <- tmp[order(tmp, decreasing = TRUE)]
  dup <- which(duplicated(tmp))
  if (length(dup) > 0) {
    tmp <- tmp[-dup]
  }
  if (length(tmp) > ceiling(nrow(top_words_tmp_sub) / 2)) {
    tmp <- tmp[seq(ceiling(nrow(top_words_tmp_sub) / 2))]
  }
  if (length(tmp) == 1) {
    tmp[1] <- 4
  } else {
    tmp <- (tmp - min(tmp)) / (max(tmp) - min(tmp)) + 3
  }
  # if (length(tmp) >= 1) {
    # tmp <- tmp[1:1]
    # tmp <- paste(paste0(tmp, "\n"), collapse = "")
    # tmp <- substr(tmp, 1, nchar(tmp) - 1)
  # } else if (length(tmp > 0)) {
  #   add <- 1 - length(tmp)
  #   tmp2 <- unlist(strsplit(suppressWarnings(word_cloud(top_words_tmp_sub$gene_set, dict = dict)), "\\s+"))
  #   tmp2 <- tmp2[tmp2 %notin% tmp]
  #   tmp <- c(tmp, tmp2[1:add])
  #   if (any(is.na(tmp))) {
  #     tmp <- tmp[-which(is.na(tmp))]
  #   }
  #   tmp <- paste(paste0(tmp, "\n"), collapse = "")
  #   tmp <- substr(tmp, 1, nchar(tmp) - 1)
  # } else {
  #   tmp <- suppressWarnings(word_cloud(top_words_tmp_sub$gene_set, 1, dict = dict))
  # }
  top_words_left[[i]] <- data.frame(words = names(tmp), fontsize = as.vector(tmp))
  top_words_left_title <- c(top_words_left_title, paste(paste0(names(tmp), "\n"), collapse = ""))
}

mat <- gse_cpm
mat <- mat[rownames(mat) %in% markers_left$gene, ]
mat <- mat[match(markers_left$gene, rownames(mat)), ]

top_gse_left <- vector("list", length = length(modules))
top_gse_left_all <- top_gse_left
top_gse_left_words <- top_gse_left
for (j in seq_along(top_gse_left)) {
  top_gse_left[[j]] <- vector("list", length = length(top_words_left[[j]]$words))
  top_gse_left_all[[j]] <- top_gse_left[[j]]
  top_gse_left_words[[j]] <- top_gse_left[[j]]
  names(top_gse_left[[j]]) <- top_words_left[[j]]$words
  names(top_gse_left_all[[j]]) <- names(top_gse_left[[j]])
  names(top_gse_left_words[[j]]) <- names(top_gse_left[[j]])
  for (i in seq_along(top_gse_left[[j]])) {
    idx <- c(
      grep(names(top_gse_left[[j]])[i], x = unlist(top_words_list[[j]]))
    )
    top_gse_left[[j]][[i]] <- modules[[j]][idx]
    genes <- geneIds(gene_sets[names(gene_sets) %in% top_gse_left[[j]][[i]]])
    genes <- genes[match(top_gse_left[[j]][[i]], names(genes))]
    idx <- colSums(
      sapply(genes, "%in%", x = c(hub_gene_list_left[[j]], NA, NA))
    ) >= ceiling(length(hub_gene_list_left[[j]]) / 4)
    top_gse_left[[j]][[i]] <- top_gse_left[[j]][[i]][idx]
    top_gse_left_all[[j]][[i]] <- modules[[j]]
    idx <- c(
      grep(names(top_gse_left[[j]])[i], x = unlist(top_words_list_all[[j]]))
    )
    top_gse_left_words[[j]][[i]] <- markers_left[order_left[[j]], ]$gene[idx]
  }
}

top_genes_left <- vector("list", length = length(modules))
top_genes_left_all <- top_genes_left
for (i in seq_along(top_genes_left)) {
  genes <- c()
  # for (gse_names in c(unlist(top_gse_left[[i]]), unlist(top_gse_left_all[[i]]))) {
  #   genes <- c(genes, geneIds(gene_sets[names(gene_sets) %in% gse_names])[[1]])
  # }
  for (gse_names in unlist(top_gse_left[[i]])) {
    genes <- c(genes, geneIds(gene_sets[names(gene_sets) %in% gse_names])[[1]])
  }
  # genes <- table(genes) / length(c(unlist(top_gse_left[[i]]), unlist(top_gse_left_all[[i]])))
  genes <- table(genes) / length(unlist(top_gse_left[[i]]))
  genes <- genes[names(genes) %in% unlist(hub_gene_list_left[[i]])]

  # counts_cpm_scaled <- t(
  #   apply(counts_cpm, MARGIN = 1, FUN = function (x) ((2 * (x - min(x)) / (max(x) - min(x))) - 1))
  # )
  avg_log2FC <- results_left$Coef
  names(avg_log2FC) <- rownames(results_left)
  # counts_cpm_scaled <- (2 * (counts_cpm - min(counts_cpm)) / (max(counts_cpm) - min(counts_cpm))) - 1
  # if (i == 1) {
    # avg_log2FC_scaled <- (avg_log2FC - max(avg_log2FC)) / (min(avg_log2FC) - max(avg_log2FC))
  #   avg_log2FC <- avg_log2FC[avg_log2FC > 0]
  # } else {
  #   avg_log2FC_scaled <- (avg_log2FC - max(avg_log2FC)) / (min(avg_log2FC) - max(avg_log2FC))
  #   avg_log2FC <- avg_log2FC[avg_log2FC < -0]
  # }
  avg_log2FC_scaled <- avg_log2FC_all_scaled[names(avg_log2FC_all_scaled) %in% names(avg_log2FC)]
  avg_log2FC_scaled <- avg_log2FC_scaled[names(avg_log2FC_scaled) %in% names(genes)]
  # genes <- genes[names(genes) %in% names(avg_log2FC_scaled)]
  # avg_log2FC_scaled <- avg_log2FC_scaled[match(names(genes), names(avg_log2FC_scaled))]
  counts_cpm_sub <- counts_cpm[rownames(counts_cpm) %in% names(genes), , drop = FALSE]
  counts_cpm_sub <- counts_cpm_sub[match(names(genes), rownames(counts_cpm_sub)), , drop = FALSE]

  counts_cpm_sub <- SingleCellExperiment(assays = list(counts = counts_cpm_sub))
  counts_cpm_sub$groups <- groups
  counts_cpm_sub <- suppressWarnings(
    aggregateAcrossCells(
      counts_cpm_sub, colData(counts_cpm_sub)[ , "groups"],
      use_exprs_values = "counts", statistics = "mean"
    )
  )
  counts_cpm_sub <- counts(counts_cpm_sub)

  matches_sub <- module_membership_norm_scaled[names(module_membership_norm_scaled) %in% names(genes)]
  # matches_sub <- matches_sub[match(names(genes), names(matches_sub))]
  # matches_sub <- (matches_sub - min(matches_sub)) / (max(matches_sub) - min(matches_sub))

  matching <- intersect(intersect(names(genes), names(avg_log2FC_scaled)), names(matches_sub))
  genes_int <- genes[names(genes) %in% matching]
  avg_log2FC_scaled_int <- avg_log2FC_scaled[names(avg_log2FC_scaled) %in% matching]
  matches_sub_int <- matches_sub[names(matches_sub) %in% matching]

  avg_log2FC_scaled_int <- avg_log2FC_scaled_int[match(names(genes_int), names(avg_log2FC_scaled_int))]
  matches_sub_int <- matches_sub_int[match(names(genes_int), names(matches_sub_int))]

  aggr <- genes_int * avg_log2FC_scaled_int * matches_sub_int
  aggr <- aggr[order(aggr, decreasing = TRUE)]

  genes_int <- genes_int[order(genes_int, decreasing = TRUE)]
  avg_log2FC_scaled_int <- avg_log2FC_scaled_int[order(avg_log2FC_scaled_int, decreasing = TRUE)]
  matches_sub_int <- matches_sub_int[order(matches_sub_int, decreasing = TRUE)]

  comb <- genes_int * avg_log2FC_scaled_int * matches_sub_int
  comb <- comb[names(comb) %in% hub_gene_list_left[[i]]]
  hub_gene_list_sub <- hub_gene_list_left[[i]][
    hub_gene_list_left[[i]] %in% names(comb)
  ]
  comb <- comb[match(hub_gene_list_sub, names(comb))]
  # comb <- c(comb, avg_log2FC_scaled_int[names(avg_log2FC_scaled_int) %notin% names(comb)][1])
  # comb <- c(comb, genes_int[names(genes_int) %notin% names(comb)][1])
  # comb <- c(comb, matches_sub_int[names(matches_sub_int) %notin% names(comb)][1])

  counts_cpm_sub <- counts_cpm_sub[match(names(comb), rownames(counts_cpm_sub)), , drop = FALSE]
  # genes <- genes[match(names(comb), names(genes))]
  # avg_log2FC <- abs(avg_log2FC[names(avg_log2FC) %in% names(counts_cpm_sub)])
  # avg_log2FC <- avg_log2FC[match(names(comb), names(avg_log2FC))]

  top_genes_left[[i]] <- c(
    comb, counts_cpm_sub[ , 2, drop = FALSE], counts_cpm_sub[ , 2 - 1, drop = FALSE]
  )
  # names(top_genes_left[[i]]) <- c(
  #   rep(
  #     gene_anno[which(gene_anno$ensembl_gene_id == names(top_genes_left[[i]])[1]), ]$external_gene_name, times = 1
  #   ), "#bbcde8", "#fcc6b6"
  # )

  idx <- grep("ENSG", x = names(top_genes_left[[i]]))
  add <- gene_anno[gene_anno$ensembl_gene_id %in% names(top_genes_left[[i]])[idx], ]$external_gene_name
  names(top_genes_left[[i]]) <- c(add, rep("#bbcde8", times = length(add)), rep("#fcc6b6", times = length(add)))

  top_genes_left_all[[i]] <- names(comb)
}

names(top_genes_left) <- seq(max(as.numeric(markers_left$cluster)))
names(top_words_left) <- levels(optimal_k_left)

markers_right <- markers[markers$gene %in% module_direction[[2]], ]
order_right <- suppressWarnings(row_order(heatmap_right))
modules <- order_right
module_names <- modules
names(order_right) <- seq(length(order_right))
markers_tmp <- markers_right[unlist(order_right), ]
markers_tmp$cluster <- unlist(
  lapply(seq_along(order_right), function(i) {rep(names(order_right)[i], length(order_right[[i]]))})
)
markers_tmp <- markers_tmp[match(markers_right$gene, markers_tmp$gene), ]
markers_right$cluster <- factor(markers_tmp$cluster, levels = seq(max(as.numeric(markers_tmp$cluster))))
# markers_right$number <- seq(markers_right$gene)
# markers_right$cluster <- unlist(suppressWarnings(row_order(heatmap_right)))

optimal_k_right <- markers_right$cluster

go_anno <- select(GO.db, markers_right$gene, c("GOID", "TERM", "DEFINITION"), "TERM")
for (l in seq_along(module_names)) {
  module_names[[l]] <- paste0(markers_right$gene[module_names[[l]]], " ", go_anno$DEFINITION[module_names[[l]]])
}
for (l in seq_along(modules)) {
  modules[[l]] <- markers_right$gene[modules[[l]]]
}
top_words_tmp <- data.frame(
  gene_sets = unlist(module_names), module = rep(seq_along(module_names), lapply(module_names, length))
)
top_words_list <- vector("list", length = length(unique(top_words_tmp$module)))
top_words_right <- top_words_list
top_words_right_title <- c()

dict_list <- top_words_list
for (i in seq_along(top_words_list)) {
  top_words_tmp_sub <- top_words_tmp[top_words_tmp$module == i, ]
  top_words_list[[i]] <- vector("list", nrow(top_words_tmp_sub))
  for (j in seq_along(top_words_list[[i]])) {
    top_words_list[[i]][[j]] <- suppressWarnings(word_cloud(top_words_tmp_sub$gene_sets[j]))
  }
  tmp <- strsplit(paste(unlist(top_words_list[[i]]), collapse = " "), "\\s+")[[1]]
  remove <- which(tmp == "")
  if (length(remove) > 0) {
    tmp <- tmp[-which(tmp == "")]
  }
  dict_list[[i]] <- unique(tmp)
}
dict <- table(unlist(dict_list))
dict <- names(dict[dict > ceiling(length(dict_list) / 2)])
# dict <- names(dict[dict > ceiling(sqrt(length(dict_list)))])
# dict <- names(dict[dict == length(dict_list)])
dict <- c()

dict_list <- top_words_list
for (i in seq_along(top_words_list)) {
  top_words_tmp_sub <- top_words_tmp[top_words_tmp$module == i, ]
  top_words_list[[i]] <- vector("list", nrow(top_words_tmp_sub))
  for (j in seq_along(top_words_list[[i]])) {
    top_words_list[[i]][[j]] <- suppressWarnings(word_cloud(top_words_tmp_sub$gene_sets[j], dict = dict))
  }
  tmp <- strsplit(paste(unlist(top_words_list[[i]]), collapse = " "), "\\s+")[[1]]
  remove <- which(tmp == "")
  if (length(remove) > 0) {
    tmp <- tmp[-which(tmp == "")]
  }
  dict_list[[i]] <- unique(tmp)
}

top_words_list_all <- top_words_list
for (i in seq_along(top_words_list)) {
  top_words_tmp_sub <- top_words_tmp[top_words_tmp$module == i, ]
  genes <- gene_sets[names(gene_sets) %in% modules[[i]]]
  genes <- geneIds(genes[match(modules[[i]], names(genes))])
  idx <- colSums(
    sapply(genes, "%in%", x = c(hub_gene_list_right[[i]], NA, NA))
  )  >= ceiling(length(hub_gene_list_right[[i]]) / 4)
  top_words_tmp_sub <- top_words_tmp_sub[idx, ]
  markers_sub <- markers_right[which(markers_right$cluster == levels(markers_right$cluster)[i]), , drop = FALSE]
  markers_sub <- markers_sub[match(modules[[i]], markers_sub$gene), , drop = FALSE]
  markers_sub <- markers_sub[idx, , drop = FALSE]
  modules[[i]] <- modules[[i]][idx]
  top_words_list[[i]] <- vector("list", nrow(top_words_tmp_sub))
  for (j in seq_along(top_words_list[[i]])) {
    top_words_list[[i]][[j]] <- suppressWarnings(word_cloud(top_words_tmp_sub$gene_sets[j], dict = dict))
  }
  tmp <- strsplit(paste(unlist(top_words_list[[i]]), collapse = " "), "\\s+")[[1]]
  remove <- which(tmp == "")
  if (length(remove) > 0) {
    tmp <- tmp[-which(tmp == "")]
  }
  tmp <- table(tmp)
  for (j in seq_along(tmp)) {
    # tmp[j] <- grep(paste0("\\b", names(tmp)[j], "\\b"), unlist(top_words_list[[i]]))
    log2FC <- grep(paste0("\\b", names(tmp)[j], "\\b"), unlist(top_words_list[[i]]))
    tmp[j] <- sum(markers_sub$avg_log2FC[log2FC])
  }
  tmp <- tmp[order(tmp, decreasing = TRUE)]
  remove <- c()
  for (j in seq_along(tmp)) {
    dup <- grep(substr(names(tmp)[j], 1, ceiling(nchar(names(tmp)[j]) / 2)), x = names(tmp))
    if (length(dup) > 1) {
      tmp[dup[1]] <- sum(tmp[dup])
      remove <- c(remove, dup[-1])
    }
  }
  if (length(remove) > 0) {
    tmp <- tmp[-remove]
  }
  tmp <- tmp[order(tmp, decreasing = TRUE)]
  dup <- which(duplicated(tmp))
  if (length(dup) > 0) {
    tmp <- tmp[-dup]
  }
  if (length(tmp) > ceiling(nrow(top_words_tmp_sub) / 2)) {
    tmp <- tmp[seq(ceiling(nrow(top_words_tmp_sub) / 2))]
  }
  if (length(tmp) == 1) {
    tmp[1] <- 4
  } else {
    tmp <- (tmp - min(tmp)) / (max(tmp) - min(tmp)) + 3
  }
  # if (length(tmp) >= 1) {
    # tmp <- tmp[1:1]
    # tmp <- paste(paste0(tmp, "\n"), collapse = "")
    # tmp <- substr(tmp, 1, nchar(tmp) - 1)
  # } else if (length(tmp > 0)) {
  #   add <- 1 - length(tmp)
  #   tmp2 <- unlist(strsplit(suppressWarnings(word_cloud(top_words_tmp_sub$gene_set, dict = dict)), "\\s+"))
  #   tmp2 <- tmp2[tmp2 %notin% tmp]
  #   tmp <- c(tmp, tmp2[1:add])
  #   if (any(is.na(tmp))) {
  #     tmp <- tmp[-which(is.na(tmp))]
  #   }
  #   tmp <- paste(paste0(tmp, "\n"), collapse = "")
  #   tmp <- substr(tmp, 1, nchar(tmp) - 1)
  # } else {
  #   tmp <- suppressWarnings(word_cloud(top_words_tmp_sub$gene_set, 1, dict = dict))
  # }
  top_words_right[[i]] <- data.frame(words = names(tmp), fontsize = as.vector(tmp))
  top_words_right_title <- c(top_words_right_title, paste(paste0(names(tmp), "\n"), collapse = ""))
}

mat <- gse_cpm
mat <- mat[rownames(mat) %in% markers_right$gene, ]
mat <- mat[match(markers_right$gene, rownames(mat)), ]

top_gse_right <- vector("list", length = length(modules))
top_gse_right_all <- top_gse_right
top_gse_right_words <- top_gse_right
for (j in seq_along(top_gse_right)) {
  top_gse_right[[j]] <- vector("list", length = length(top_words_right[[j]]$words))
  top_gse_right_all[[j]] <- top_gse_right[[j]]
  top_gse_right_words[[j]] <- top_gse_right[[j]]
  names(top_gse_right[[j]]) <- top_words_right[[j]]$words
  names(top_gse_right_all[[j]]) <- names(top_gse_right[[j]])
  names(top_gse_right_words[[j]]) <- names(top_gse_right[[j]])
  for (i in seq_along(top_gse_right[[j]])) {
    idx <- c(
      grep(names(top_gse_right[[j]])[i], x = unlist(top_words_list[[j]]))
    )
    top_gse_right[[j]][[i]] <- modules[[j]][idx]
    genes <- geneIds(gene_sets[names(gene_sets) %in% top_gse_right[[j]][[i]]])
    genes <- genes[match(top_gse_right[[j]][[i]], names(genes))]
    idx <- colSums(
      sapply(genes, "%in%", x = c(hub_gene_list_right[[j]], NA, NA))
    ) >= ceiling(length(hub_gene_list_right[[j]]) / 4)
    top_gse_right[[j]][[i]] <- top_gse_right[[j]][[i]][idx]
    top_gse_right_all[[j]][[i]] <- modules[[j]]
    idx <- c(
      grep(names(top_gse_right[[j]])[i], x = unlist(top_words_list_all[[j]]))
    )
    top_gse_right_words[[j]][[i]] <- markers_right[order_right[[j]], ]$gene[idx]
  }
}

top_genes_right <- vector("list", length = length(modules))
top_genes_right_all <- top_genes_right
for (i in seq_along(top_genes_right)) {
  genes <- c()
  # for (gse_names in c(unlist(top_gse_right[[i]]), unlist(top_gse_right_all[[i]]))) {
  #   genes <- c(genes, geneIds(gene_sets[names(gene_sets) %in% gse_names])[[1]])
  # }
  for (gse_names in unlist(top_gse_right[[i]])) {
    genes <- c(genes, geneIds(gene_sets[names(gene_sets) %in% gse_names])[[1]])
  }
  # genes <- table(genes) / length(c(unlist(top_gse_right[[i]]), unlist(top_gse_right_all[[i]])))
  genes <- table(genes) / length(unlist(top_gse_right[[i]]))
  genes <- genes[names(genes) %in% unlist(hub_gene_list_right[[i]])]

  # counts_cpm_scaled <- t(
  #   apply(counts_cpm, MARGIN = 1, FUN = function (x) ((2 * (x - min(x)) / (max(x) - min(x))) - 1))
  # )
  avg_log2FC <- results_right$Coef
  names(avg_log2FC) <- rownames(results_right)
  # counts_cpm_scaled <- (2 * (counts_cpm - min(counts_cpm)) / (max(counts_cpm) - min(counts_cpm))) - 1
  # if (i == 1) {
    # avg_log2FC_scaled <- (avg_log2FC - max(avg_log2FC)) / (min(avg_log2FC) - max(avg_log2FC))
  #   avg_log2FC <- avg_log2FC[avg_log2FC > 0]
  # } else {
  #   avg_log2FC_scaled <- (avg_log2FC - max(avg_log2FC)) / (min(avg_log2FC) - max(avg_log2FC))
  #   avg_log2FC <- avg_log2FC[avg_log2FC < -0]
  # }
  avg_log2FC_scaled <- avg_log2FC_all_scaled_rev[names(avg_log2FC_all_scaled_rev) %in% names(avg_log2FC)]
  avg_log2FC_scaled <- avg_log2FC_scaled[names(avg_log2FC_scaled) %in% names(genes)]
  # genes <- genes[names(genes) %in% names(avg_log2FC_scaled)]
  # avg_log2FC_scaled <- avg_log2FC_scaled[match(names(genes), names(avg_log2FC_scaled))]
  counts_cpm_sub <- counts_cpm[rownames(counts_cpm) %in% names(genes), , drop = FALSE]
  counts_cpm_sub <- counts_cpm_sub[match(names(genes), rownames(counts_cpm_sub)), , drop = FALSE]

  counts_cpm_sub <- SingleCellExperiment(assays = list(counts = counts_cpm_sub))
  counts_cpm_sub$groups <- groups
  counts_cpm_sub <- suppressWarnings(
    aggregateAcrossCells(
      counts_cpm_sub, colData(counts_cpm_sub)[ , "groups"],
      use_exprs_values = "counts", statistics = "mean"
    )
  )
  counts_cpm_sub <- counts(counts_cpm_sub)

  matches_sub <- module_membership_norm_scaled[names(module_membership_norm_scaled) %in% names(genes)]
  # matches_sub <- matches_sub[match(names(genes), names(matches_sub))]
  # matches_sub <- (matches_sub - min(matches_sub)) / (max(matches_sub) - min(matches_sub))

  matching <- intersect(intersect(names(genes), names(avg_log2FC_scaled)), names(matches_sub))
  genes_int <- genes[names(genes) %in% matching]
  avg_log2FC_scaled_int <- avg_log2FC_scaled[names(avg_log2FC_scaled) %in% matching]
  matches_sub_int <- matches_sub[names(matches_sub) %in% matching]

  avg_log2FC_scaled_int <- avg_log2FC_scaled_int[match(names(genes_int), names(avg_log2FC_scaled_int))]
  matches_sub_int <- matches_sub_int[match(names(genes_int), names(matches_sub_int))]

  aggr <- genes_int * avg_log2FC_scaled_int * matches_sub_int
  aggr <- aggr[order(aggr, decreasing = TRUE)]

  genes_int <- genes_int[order(genes_int, decreasing = TRUE)]
  avg_log2FC_scaled_int <- avg_log2FC_scaled_int[order(avg_log2FC_scaled_int, decreasing = TRUE)]
  matches_sub_int <- matches_sub_int[order(matches_sub_int, decreasing = TRUE)]

  comb <- genes_int * avg_log2FC_scaled_int * matches_sub_int
  comb <- comb[names(comb) %in% hub_gene_list_right[[i]]]
  hub_gene_list_sub <- hub_gene_list_right[[i]][
    hub_gene_list_right[[i]] %in% names(comb)
  ]
  comb <- comb[match(hub_gene_list_sub, names(comb))]
  # comb <- c(comb, avg_log2FC_scaled_int[names(avg_log2FC_scaled_int) %notin% names(comb)][1])
  # comb <- c(comb, genes_int[names(genes_int) %notin% names(comb)][1])
  # comb <- c(comb, matches_sub_int[names(matches_sub_int) %notin% names(comb)][1])

  counts_cpm_sub <- counts_cpm_sub[match(names(comb), rownames(counts_cpm_sub)), , drop = FALSE]
  # genes <- genes[match(names(comb), names(genes))]
  # avg_log2FC <- abs(avg_log2FC[names(avg_log2FC) %in% names(counts_cpm_sub)])
  # avg_log2FC <- avg_log2FC[match(names(comb), names(avg_log2FC))]

  top_genes_right[[i]] <- c(
    comb, counts_cpm_sub[ , 2, drop = FALSE], counts_cpm_sub[ , 2 - 1, drop = FALSE]
  )
  # names(top_genes_right[[i]]) <- c(
  #   rep(
  #     gene_anno[which(gene_anno$ensembl_gene_id == names(top_genes_right[[i]])[1]), ]$external_gene_name, times = 1
  #   ), "#fcc6b6", "#bbcde8"
  # )

  idx <- grep("ENSG", x = names(top_genes_right[[i]]))
  add <- gene_anno[gene_anno$ensembl_gene_id %in% names(top_genes_right[[i]])[idx], ]$external_gene_name
  names(top_genes_right[[i]]) <- c(add, rep("#fcc6b6", times = length(add)), rep("#bbcde8", times = length(add)))

  top_genes_right_all[[i]] <- names(comb)
}

names(top_genes_right) <- seq(max(as.numeric(markers_right$cluster)))
names(top_words_right) <- levels(optimal_k_right)
```

```{r, fig.height = 4, fig.width = 3}
panel_fun <- function(index, nm) {
  pushViewport(viewport(xscale = c(0, 10)))

  if (length(top_genes_left[[nm]]) == 3) {
    grid.rect(
      x = 0, y = 0.5, width = top_genes_left[[nm]][3] / 10,
      height = 1, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][3]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.5, width = top_genes_left[[nm]][2] / 10,
      height = 1, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][2]), lwd = 0, col = "white")
    )
    grid.text(y = 0.5, names(top_genes_left[[nm]])[1], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
  } else if (length(top_genes_left[[nm]]) == 6) {
    grid.rect(
      x = 0, y = 0.75, width = top_genes_left[[nm]][5] / 10,
      height = 0.5, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][5]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.75, width = top_genes_left[[nm]][3] / 10,
      height = 0.5, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][3]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.25, width = top_genes_left[[nm]][6] / 10,
      height = 0.5, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][6]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.25, width = top_genes_left[[nm]][4] / 10,
      height = 0.5, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][4]), lwd = 0, col = "white")
    )
    grid.text(y = 0.75, names(top_genes_left[[nm]])[1], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
    grid.text(y = 0.25, names(top_genes_left[[nm]])[2], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
  } else if (length(top_genes_left[[nm]]) == 9) {
    grid.rect(
      x = 0, y = 0.5 + 1 / 3, width = top_genes_left[[nm]][7] / 10,
      height = 1 / 3, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][7]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.5 + 1 / 3, width = top_genes_left[[nm]][4] / 10,
      height = 1 / 3, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][4]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.5, width = top_genes_left[[nm]][8] / 10,
      height = 1 / 3, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][8]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.5, width = top_genes_left[[nm]][5] / 10,
      height = 1 / 3, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][5]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.5 - 1 / 3, width = top_genes_left[[nm]][9] / 10,
      height = 1 / 3, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][9]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.5 - 1 / 3, width = top_genes_left[[nm]][6] / 10,
      height = 1 / 3, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][6]), lwd = 0, col = "white")
    )
    grid.text(
      y = 0.5 + 1 / 3, names(top_genes_left[[nm]])[1], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left"
    )
    grid.text(y = 0.5, names(top_genes_left[[nm]])[2], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
    grid.text(
      y = 0.5 - 1 / 3, names(top_genes_left[[nm]])[3], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left"
    )
  } else if (length(top_genes_left[[nm]]) == 12) {
    grid.rect(
      x = 0, y = 0.875, width = top_genes_left[[nm]][9] / 10,
      height = 0.25, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][9]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.875, width = top_genes_left[[nm]][5] / 10,
      height = 0.25, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][5]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.625, width = top_genes_left[[nm]][10] / 10,
      height = 0.25, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][10]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.625, width = top_genes_left[[nm]][6] / 10,
      height = 0.25, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][6]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.375, width = top_genes_left[[nm]][11] / 10,
      height = 0.25, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][11]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.375, width = top_genes_left[[nm]][7] / 10,
      height = 0.25, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][7]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.125, width = top_genes_left[[nm]][12] / 10,
      height = 0.25, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][12]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.125, width = top_genes_left[[nm]][8] / 10,
      height = 0.25, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][8]), lwd = 0, col = "white")
    )
    grid.text(y = 0.875, names(top_genes_left[[nm]])[1], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
    grid.text(y = 0.625, names(top_genes_left[[nm]])[2], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
    grid.text(y = 0.375, names(top_genes_left[[nm]])[3], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
    grid.text(y = 0.125, names(top_genes_left[[nm]])[4], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
  } else if (length(top_genes_left[[nm]]) == 15) {
    grid.rect(
      x = 0, y = 0.9, width = top_genes_left[[nm]][11] / 10,
      height = 0.2, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][11]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.9, width = top_genes_left[[nm]][6] / 10,
      height = 0.2, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][6]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.7, width = top_genes_left[[nm]][12] / 10,
      height = 0.2, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][12]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.7, width = top_genes_left[[nm]][7] / 10,
      height = 0.2, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][7]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.5, width = top_genes_left[[nm]][13] / 10,
      height = 0.2, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][13]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.5, width = top_genes_left[[nm]][8] / 10,
      height = 0.2, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][8]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.3, width = top_genes_left[[nm]][14] / 10,
      height = 0.2, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][14]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.3, width = top_genes_left[[nm]][9] / 10,
      height = 0.2, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][9]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.1, width = top_genes_left[[nm]][15] / 10,
      height = 0.2, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][15]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.1, width = top_genes_left[[nm]][10] / 10,
      height = 0.2, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][10]), lwd = 0, col = "white")
    )
    grid.text(y = 0.9, names(top_genes_left[[nm]])[1], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
    grid.text(y = 0.7, names(top_genes_left[[nm]])[2], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
    grid.text(y = 0.5, names(top_genes_left[[nm]])[3], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
    grid.text(y = 0.3, names(top_genes_left[[nm]])[4], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
    grid.text(y = 0.1, names(top_genes_left[[nm]])[5], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
  }

  grid.xaxis(gp = gpar(fontsize = 2, lwd = 0.5), main = FALSE, label = FALSE)
  popViewport()
}

right_anno <-  HeatmapAnnotation(
  top_genes = anno_link(
    align_to = optimal_k_left, which = "row", panel_fun = panel_fun,
    link_width = unit(0, "mm"), gap = unit(0.75, "mm"), width = unit(7, "mm")
  ),
  which = "row",
  clusters = anno_block(
    gp = gpar(col = module_colors[seq(optimal_k[1])], lwd = 0.5),
    labels = seq(length(unique(optimal_k_left))),
    labels_rot = 0,
    labels_gp = gpar(fontsize = 3),
    width = unit(1.2, "mm")
  ),
  word_cloud = anno_textbox(
    optimal_k_left, text = top_words_left, add_new_line = TRUE, line_space = unit(0.4, "mm"),
    padding = unit(c(0.5, 0.1, 0.25, 0.5), "mm"),
    background_gp = gpar(fill = "transparent", lwd = 0.75),
  ),
  width = unit(2.25, "cm")
)

left_anno <- rowAnnotation(
  top_gse = anno_mark(
    at = which(rownames(mat_left) %in% unlist(top_gse_left)),
    labels = rownames(mat_left)[which(rownames(mat_left) %in% unlist(top_gse_left))],
    link_gp = gpar(lwd = 0.3),
    labels_gp = gpar(fontsize = 3),
    link_width = unit(0.3, "mm"),
    padding = unit(0.3, "mm"),
    side = "left"
  )
)

anno_colour <- hue_pal()(8)
top_anno <- HeatmapAnnotation(
  Donor = paste0("Donor ", rep(1:8, times = 2)),
  `0  LogCPM 10` = anno_block(
    gp = gpar(fill = c("#fcc6b6", "#bbcde8"), lwd = 0.5),
    labels = unique(groups),
    labels_gp = gpar(fontsize = 3),
    height = unit(1.5, "mm"),
    show_name = TRUE,
  ),
  col = list(
    Donor = c(
      "Donor 1" = anno_colour[1], "Donor 2" = anno_colour[2], "Donor 3" = anno_colour[3], "Donor 4" = anno_colour[4],
      "Donor 5" = anno_colour[5], "Donor 6" = anno_colour[6], "Donor 7" = anno_colour[7], "Donor 8" = anno_colour[8]
    )
  ),
  simple_anno_size = unit(0.75, "mm"),
  show_legend = FALSE,
  annotation_name_gp = gpar(fontsize = 3)
)

colour_left <- colorRamp2(
  c(min(mat_left), (min(mat_left) + max(mat_left)) / 2, max(mat_left)), c("#0077BB", "#FFFFFF", "#CC3311")
)

set.seed(1)
draw(
  Heatmap(
    t(scale(t(mat_left))),
    col = colour,
    column_labels = sub("\\s+[^ ]+$", "", colnames(mat_left)),
    show_row_names = FALSE,
    cluster_columns = FALSE,
    cluster_rows = clustering_left,
    row_split = optimal_k[1],
    column_split = factor(groups, levels = unique(groups)),
    show_column_names = FALSE,
    column_title = paste0(ctype, " (AdjP < 0.05)"),
    column_title_gp = gpar(fontsize = 4),
    left_annotation = left_anno,
    right_annotation = right_anno,
    top_annotation = top_anno,
    rect_gp = gpar(col = "lightgray", lwd = 0.1),
    border_gp = gpar(lwd = 0.5),
    border = TRUE,
    row_title = NULL,
    row_title_gp = gpar(fontsize = 4),
    row_title_rot = 0,
    show_row_dend = FALSE,
    row_gap = unit(0.75, "mm"),
    column_gap = unit(0.5, "mm"),
    column_names_side = "top",
    column_names_rot = 45,
    heatmap_legend_param = list(
      title = "Z-Score", direction = "horizontal", title_position = "topcenter",
      legend_width = unit(1.5, "cm"), title_gp = gpar(fontsize = 3.5), labels_gp = gpar(fontsize = 3),
      grid_height = unit(0.075, "cm"), at = c(-3, -2, -1, 0, 1, 2, 3)
    )
  ),
  heatmap_legend_side = "top",
)

panel_fun <- function(index, nm) {
  pushViewport(viewport(xscale = c(0, 10)))

  if (length(top_genes_right[[nm]]) == 3) {
    grid.rect(
      x = 0, y = 0.5, width = top_genes_right[[nm]][2] / 10,
      height = 1, just = "left", gp = gpar(fill = names(top_genes_right[[nm]][2]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.5, width = top_genes_right[[nm]][3] / 10,
      height = 1, just = "left", gp = gpar(fill = names(top_genes_right[[nm]][3]), lwd = 0, col = "white")
    )
    grid.text(y = 0.5, names(top_genes_right[[nm]])[1], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
  } else if (length(top_genes_right[[nm]]) == 6) {
    grid.rect(
      x = 0, y = 0.75, width = top_genes_right[[nm]][3] / 10,
      height = 0.5, just = "left", gp = gpar(fill = names(top_genes_right[[nm]][3]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.75, width = top_genes_right[[nm]][5] / 10,
      height = 0.5, just = "left", gp = gpar(fill = names(top_genes_right[[nm]][5]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.25, width = top_genes_right[[nm]][4] / 10,
      height = 0.5, just = "left", gp = gpar(fill = names(top_genes_right[[nm]][4]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.25, width = top_genes_right[[nm]][6] / 10,
      height = 0.5, just = "left", gp = gpar(fill = names(top_genes_right[[nm]][6]), lwd = 0, col = "white")
    )
    grid.text(y = 0.75, names(top_genes_right[[nm]])[1], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
    grid.text(y = 0.25, names(top_genes_right[[nm]])[2], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
  } else if (length(top_genes_right[[nm]]) == 9) {
    grid.rect(
      x = 0, y = 0.5 + 1 / 3, width = top_genes_right[[nm]][4] / 10,
      height = 1 / 3, just = "left", gp = gpar(fill = names(top_genes_right[[nm]][4]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.5 + 1 / 3, width = top_genes_right[[nm]][7] / 10,
      height = 1 / 3, just = "left", gp = gpar(fill = names(top_genes_right[[nm]][7]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.5, width = top_genes_right[[nm]][5] / 10,
      height = 1 / 3, just = "left", gp = gpar(fill = names(top_genes_right[[nm]][5]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.5, width = top_genes_right[[nm]][8] / 10,
      height = 1 / 3, just = "left", gp = gpar(fill = names(top_genes_right[[nm]][8]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.5 - 1 / 3, width = top_genes_right[[nm]][6] / 10,
      height = 1 / 3, just = "left", gp = gpar(fill = names(top_genes_right[[nm]][6]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.5 - 1 / 3, width = top_genes_right[[nm]][9] / 10,
      height = 1 / 3, just = "left", gp = gpar(fill = names(top_genes_right[[nm]][9]), lwd = 0, col = "white")
    )
    grid.text(
      y = 0.5 + 1 / 3, names(top_genes_right[[nm]])[1], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left"
    )
    grid.text(y = 0.5, names(top_genes_right[[nm]])[2], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
    grid.text(
      y = 0.5 - 1 / 3, names(top_genes_right[[nm]])[3], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left"
    )
  } else if (length(top_genes_right[[nm]]) == 12) {
    grid.rect(
      x = 0, y = 0.875, width = top_genes_right[[nm]][5] / 10,
      height = 0.25, just = "left", gp = gpar(fill = names(top_genes_right[[nm]][5]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.875, width = top_genes_right[[nm]][9] / 10,
      height = 0.25, just = "left", gp = gpar(fill = names(top_genes_right[[nm]][9]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.625, width = top_genes_right[[nm]][6] / 10,
      height = 0.25, just = "left", gp = gpar(fill = names(top_genes_right[[nm]][6]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.625, width = top_genes_right[[nm]][10] / 10,
      height = 0.25, just = "left", gp = gpar(fill = names(top_genes_right[[nm]][10]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.375, width = top_genes_right[[nm]][7] / 10,
      height = 0.25, just = "left", gp = gpar(fill = names(top_genes_right[[nm]][7]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.375, width = top_genes_right[[nm]][11] / 10,
      height = 0.25, just = "left", gp = gpar(fill = names(top_genes_right[[nm]][11]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.125, width = top_genes_right[[nm]][8] / 10,
      height = 0.25, just = "left", gp = gpar(fill = names(top_genes_right[[nm]][8]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.125, width = top_genes_right[[nm]][12] / 10,
      height = 0.25, just = "left", gp = gpar(fill = names(top_genes_right[[nm]][12]), lwd = 0, col = "white")
    )
    grid.text(y = 0.875, names(top_genes_right[[nm]])[1], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
    grid.text(y = 0.625, names(top_genes_right[[nm]])[2], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
    grid.text(y = 0.375, names(top_genes_right[[nm]])[3], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
    grid.text(y = 0.125, names(top_genes_right[[nm]])[4], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
  } else if (length(top_genes_left[[nm]]) == 15) {
    grid.rect(
      x = 0, y = 0.9, width = top_genes_left[[nm]][6] / 10,
      height = 0.2, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][6]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.9, width = top_genes_left[[nm]][11] / 10,
      height = 0.2, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][11]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.7, width = top_genes_left[[nm]][7] / 10,
      height = 0.2, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][7]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.7, width = top_genes_left[[nm]][12] / 10,
      height = 0.2, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][12]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.5, width = top_genes_left[[nm]][8] / 10,
      height = 0.2, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][8]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.5, width = top_genes_left[[nm]][13] / 10,
      height = 0.2, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][13]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.3, width = top_genes_left[[nm]][9] / 10,
      height = 0.2, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][9]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.3, width = top_genes_left[[nm]][14] / 10,
      height = 0.2, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][14]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.1, width = top_genes_left[[nm]][10] / 10,
      height = 0.2, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][10]), lwd = 0, col = "white")
    )
    grid.rect(
      x = 0, y = 0.1, width = top_genes_left[[nm]][15] / 10,
      height = 0.2, just = "left", gp = gpar(fill = names(top_genes_left[[nm]][15]), lwd = 0, col = "white")
    )
    grid.text(y = 0.9, names(top_genes_left[[nm]])[1], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
    grid.text(y = 0.7, names(top_genes_left[[nm]])[2], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
    grid.text(y = 0.5, names(top_genes_left[[nm]])[3], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
    grid.text(y = 0.3, names(top_genes_left[[nm]])[4], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
    grid.text(y = 0.1, names(top_genes_left[[nm]])[5], gp = gpar(fontsize = 3, font = 3), x = 0.05, just = "left")
  }

  grid.xaxis(gp = gpar(fontsize = 2, lwd = 0.5), main = FALSE, label = FALSE)
  popViewport()
}

right_anno <-  HeatmapAnnotation(
  top_genes = anno_link(
    align_to = optimal_k_right, which = "row", panel_fun = panel_fun,
    link_width = unit(0, "mm"), gap = unit(0.75, "mm"), width = unit(7, "mm")
  ),
  which = "row",
  clusters = anno_block(
    gp = gpar(col = module_colors[seq(optimal_k[2])], lwd = 0.5),
    labels = seq(length(unique(optimal_k_right))),
    labels_rot = 0,
    labels_gp = gpar(fontsize = 3),
    width = unit(1.2, "mm")
  ),
  word_cloud = anno_textbox(
    optimal_k_right, text = top_words_right, add_new_line = TRUE, line_space = unit(0.4, "mm"),
    padding = unit(c(0.5, 0.1, 0.25, 0.5), "mm"),
    background_gp = gpar(fill = "transparent", lwd = 0.75),
  ),
  width = unit(2, "cm")
)

left_anno <- rowAnnotation(
  top_gse = anno_mark(
    at = which(rownames(mat_right) %in% unlist(top_gse_right)),
    labels = rownames(mat_right)[which(rownames(mat_right) %in% unlist(top_gse_right))],
    link_gp = gpar(lwd = 0.3),
    labels_gp = gpar(fontsize = 3),
    link_width = unit(0.3, "mm"),
    padding = unit(0.3, "mm"),
    side = "left"
  )
)

anno_colour <- hue_pal()(8)
top_anno <- HeatmapAnnotation(
  Donor = paste0("Donor ", rep(1:8, times = 2)),
  `0  LogCPM 10` = anno_block(
    gp = gpar(fill = c("#bbcde8", "#fcc6b6"), lwd = 0.5),
    labels = unique(groups),
    labels_gp = gpar(fontsize = 3),
    height = unit(1.5, "mm"),
    show_name = TRUE,
  ),
  col = list(
    Donor = c(
      "Donor 1" = anno_colour[1], "Donor 2" = anno_colour[2], "Donor 3" = anno_colour[3], "Donor 4" = anno_colour[4],
      "Donor 5" = anno_colour[5], "Donor 6" = anno_colour[6], "Donor 7" = anno_colour[7], "Donor 8" = anno_colour[8]
    )
  ),
  simple_anno_size = unit(0.75, "mm"),
  show_legend = FALSE,
  annotation_name_gp = gpar(fontsize = 3)
)

colour_right <- colorRamp2(
  c(min(mat_right), (min(mat_right) + max(mat_right)) / 2, max(mat_right)), c("#0077BB", "#FFFFFF", "#CC3311")
)

set.seed(1)
draw(
  Heatmap(
    t(scale(t(mat_right))),
    col = colour,
    column_labels = sub("\\s+[^ ]+$", "", colnames(mat_right)),
    show_row_names = FALSE,
    cluster_columns = FALSE,
    cluster_rows = clustering_right,
    row_split = optimal_k[2],
    column_split = factor(groups, levels = unique(groups)),
    show_column_names = FALSE,
    column_title = paste0(ctype, " (AdjP < 0.05)"),
    column_title_gp = gpar(fontsize = 4),
    left_annotation = left_anno,
    right_annotation = right_anno,
    top_annotation = top_anno,
    rect_gp = gpar(col = "lightgray", lwd = 0.1),
    border_gp = gpar(lwd = 0.5),
    border = TRUE,
    row_title = NULL,
    row_title_gp = gpar(fontsize = 4),
    row_title_rot = 0,
    show_row_dend = FALSE,
    row_gap = unit(0.75, "mm"),
    column_gap = unit(0.5, "mm"),
    column_names_side = "top",
    column_names_rot = 45,
    heatmap_legend_param = list(
      title = "Z-Score", direction = "horizontal", title_position = "topcenter",
      legend_width = unit(1.5, "cm"), title_gp = gpar(fontsize = 3.5), labels_gp = gpar(fontsize = 3),
      grid_height = unit(0.075, "cm"), at = c(-3, -2, -1, 0, 1, 2, 3)
    )
  ),
  heatmap_legend_side = "top",
)
```

```{r}
open_targets_all <- read.delim(file.path("..", "data", "gene-sets", "OT-MONDO_0004975-associated-targets-4_15_2024-v24_03.tsv"))
open_targets_all <- open_targets_all[open_targets_all$globalScore >= 0.1, ]
open_targets <- open_targets_all[open_targets_all$globalScore >= 0.1, ]
```

```{r}
hub_gene_left_all <- lapply(hub_gene_list_left_all, function(x) cbind(rowname = rownames(x), x))
hub_gene_left_all <- Reduce(function(x, y) merge(x, y, all = TRUE), hub_gene_left_all)
hub_gene_left <- lapply(hub_gene_list_left, function(x) cbind(rowname = rownames(x), x))
hub_gene_left <- Reduce(function(x, y) merge(x, y, all = TRUE), hub_gene_left)

hub_gene_data <- vector()
for (l in seq_along(order_left)) {
  module_sets <- rownames(mat_left)[order_left[[l]]]

  # module_gene_sets_sub <- gene_sets[names(gene_sets) %in% modules_down]

  frequent_genes <- vector()

  module_gene_sets_sub <- gene_sets[names(gene_sets) %in% module_sets]
  frequent_genes_tmp <- as.data.frame(table(unlist(geneIds(module_gene_sets_sub))))
  frequent_genes_tmp <- frequent_genes_tmp[
    frequent_genes_tmp$Var1 %in% gene_anno$ensembl_gene_id,
  ]
  rownames(frequent_genes_tmp) <- NULL
  if (any(frequent_genes_tmp$Var1 %in% rownames(results_right))) {
    discard <- which(
      frequent_genes_tmp$Var1 %in% rownames(results_right)
    )
    if (length(discard) > 0) {
      frequent_genes_tmp <- frequent_genes_tmp[-discard, ]
    }
  }
  frequent_genes <- frequent_genes_tmp

  # module_gene_sets_sub <- gene_sets[names(gene_sets) %in% module_sets]
  node_data <- reshape2::melt(geneIds(module_gene_sets_sub))
  node_data <- node_data[node_data$value %in% frequent_genes$Var1, ]
  names(node_data) <- c("ensembl_gene_id", "gene_set")
  gene_anno_sub <- gene_anno[
    gene_anno$ensembl_gene_id %in% node_data$ensembl_gene_id,
  ]
  node_data <- node_data[node_data$ensembl_gene_id %in% gene_anno_sub$ensembl_gene_id, ]
  node_data <- left_join(node_data, gene_anno_sub, by = "ensembl_gene_id")
  node_data$direction <- "down"
  node_data$DE <- ifelse(
    node_data$ensembl_gene_id %in% rownames(results_sig), "yes", "no"
  )
  node_data <- node_data[node_data$ensembl_gene_id %in% hub_gene_left_all$Var1, ]
  # node_data <- node_data[node_data$DE == "yes", ]
  node_data$module <- l
  node_data$hub <- ifelse(
    node_data$ensembl_gene_id %in% unlist(top_genes_left_all), "yes", "no"
  )
  node_data$top_gse <- ifelse(
    node_data$gene_set %in% unname(unlist(top_gse_left)), "yes", "no"
  )
  # node_data <- node_data[node_data$top_gse == "yes", ]
  node_data <- node_data[node_data$hub == "yes" | node_data$external_gene_name %in% open_targets_all$symbol, ]
  hub_gene_data <- rbind(hub_gene_data, node_data)
}

unique_direction <- as.data.frame.matrix(table(hub_gene_data[ , c(3, 4)]), )
unique_direction$down <- unique_direction$down * -1
discard <- which(rowSums(unique_direction) == 0)
if (length(discard) > 0) {
  unique_direction <- unique_direction[-discard, ]
}
module_membership_norm <- unique_direction
unique_direction <- ifelse(rowSums(unique_direction) > 0, "up", "down")
hub_gene_data <- hub_gene_data[
  hub_gene_data$external_gene_name %in% names(unique_direction),
]

rownames(hub_gene_data) <- NULL
discard <- vector()
for (i_gene in seq_along(hub_gene_data$external_gene_name)) {
  sub_gene <- hub_gene_data$external_gene_name[i_gene]
  sub_unique_direction <- unique_direction[which(names(unique_direction) == sub_gene)]
  if (hub_gene_data$direction[i_gene] != sub_unique_direction[[1]]) {
    discard <- append(discard, i_gene)
  }
}
if (length(discard) > 0) {
  hub_gene_data <- hub_gene_data[-discard, ]
}

frequent_genes_tmp <- as.data.frame(table(hub_gene_data$external_gene_name))
frequent_genes <- frequent_genes_tmp
hub_gene_data <- hub_gene_data[
  hub_gene_data$external_gene_name %in% frequent_genes$Var1,
]

# hub_gene_data <- hub_gene_data[which(hub_gene_data$DE == "yes"), ]

hub_score <- c()
for (i in seq_along(unique(hub_gene_data$module))) {
  hub_gene_data_sub <- hub_gene_data[hub_gene_data$module == i, ]
  hub_gene_sub <- hub_gene_list_left_all[[i]]
  colnames(hub_gene_sub) <- c("ensembl_gene_id", "hub_score")
  hub_gene_data_sub <- left_join(hub_gene_data_sub, hub_gene_sub, by = "ensembl_gene_id")
  if (any(is.na(hub_gene_data_sub$hub_score))) {
    discard <- which(is.na(hub_gene_data_sub$hub_score))
    hub_gene_data_sub <- hub_gene_data_sub[-discard, ]
  }
  # hub_score <- c(hub_score, hub_gene_sub$Freq)
  if (i == 1) {
    hub_gene_data_new <- hub_gene_data_sub
  } else {
    hub_gene_data_new <- rbind(hub_gene_data_new, hub_gene_data_sub)
  }
}
hub_gene_data <- hub_gene_data_new

hub_gene_data_list <- vector("list", length = length(unique(hub_gene_data$module)))
names(hub_gene_data_list) <- unique(hub_gene_data$module)
for (i in seq_along(hub_gene_data_list)) {
  hub_gene_data_sub <- hub_gene_data[hub_gene_data$module %in% names(hub_gene_data_list)[i], ]
  hub_gene_data_sub <- hub_gene_data_sub[hub_gene_data_sub$hub == "yes", ]
  # hub_gene_data_list[[i]] <- quantile(hub_gene_data_sub$hub_score, probs = 0.75)
  hub_gene_data_list[[i]] <- min(hub_gene_data_sub$hub_score)
}

min <- min(unlist(hub_gene_data_list))
keep <- c()
for (i in seq(nrow(hub_gene_data))) {
  gene_set_name <- hub_gene_data$module[i]
  if (hub_gene_data$hub_score[i] >= min) {
    keep <- c(keep, i)
  }
}
# hub_gene_data <- hub_gene_data[keep, ]

# hub_gene_data_list <- vector("list", length = length(unique(hub_gene_data$gene_set)))
# names(hub_gene_data_list) <- unique(hub_gene_data$gene_set)
# for (i in seq_along(hub_gene_data_list)) {
#   hub_gene_data_sub <- hub_gene_data[hub_gene_data$gene_set %in% names(hub_gene_data_list)[i], ]
#   hub_gene_data_list[[i]] <- hub_gene_data_sub$DE
# }
# 
# remove <- which(unlist(lapply(hub_gene_data_list, FUN = function(x) all(x == "no"))))
# if (length(remove) > 0) {
#   remove <- names(hub_gene_data_list)[remove]
#   remove <- which(hub_gene_data$gene_set %in% remove)
#   hub_gene_data <- hub_gene_data[-remove, ]
# }

# hub_gene_data <- hub_gene_data[hub_gene_data$DE == "yes", ]
# hub_gene_data <- hub_gene_data[hub_gene_data$hub_score >= min(hub_gene_data_sub$hub_score), ]
# hub_gene_data <- hub_gene_data[hub_gene_data$hub_score >= 0.00001 | hub_gene_data$DE == "yes", ]

hub_gene_data_sorted <- hub_gene_data[order(hub_gene_data$hub_score, decreasing = TRUE), ]
hub_gene_data_sorted <- hub_gene_data_sorted[-which(duplicated(hub_gene_data_sorted$ensembl_gene_id)), ]
# hub_gene_data_sorted <- hub_gene_data_sorted[match(names(membership), hub_gene_data_sorted$external_gene_name), ]

# hub_score <- hub_gene_data_sorted$hub_score
# names(hub_score) <- names(membership)

hub_mat <- as.data.frame.matrix(table(hub_gene_data[ , c(3, 2)]), )
hub_mat <- hub_mat[match(hub_gene_data_sorted$external_gene_name, rownames(hub_mat)), ]
hub_mat <- hub_mat == 1
co_mat <- hub_mat %*% t(hub_mat)
diag(co_mat) <- 0
graph <- graph_from_adjacency_matrix(co_mat, "upper", TRUE)

edges <- get.edgelist(graph, FALSE)
set.seed(1)
layout <- qgraph.layout.fruchtermanreingold(
  edges, vcount = vcount(graph), weight = E(graph)$weight,
  area = vcount(graph) / 1, repulse.rad = vcount(graph) / 4
)

hub_gene_all_GO <- table(unlist(geneIds(gene_sets)))
hub_gene_all_GO <- hub_gene_all_GO[
  names(hub_gene_all_GO) %in% unique(hub_gene_data$ensembl_gene_id)
]
sub_gene_anno <- gene_anno[gene_anno$ensembl_gene_id %in% rownames(hub_gene_all_GO), ]
rownames(sub_gene_anno) <- NULL
sub_gene_anno <- sub_gene_anno[
  match(rownames(hub_gene_all_GO), sub_gene_anno$ensembl_gene_id),
]
rownames(hub_gene_all_GO) <- sub_gene_anno$external_gene_name
hub_gene_all_GO <- hub_gene_all_GO[match(hub_gene_data_sorted$external_gene_name, names(hub_gene_all_GO))]

module_membership <- as.data.frame.matrix(table(hub_gene_data[ , c(3, 6)]), )
module_membership <- module_membership[match(hub_gene_data_sorted$external_gene_name, rownames(module_membership)), ]
module_membership_binary <- module_membership
module_membership_binary[module_membership_binary > 0] <- 1
module_membership_list <- lapply(
  split(module_membership, row.names(module_membership)), unlist
)
module_membership_list <- module_membership_list[
  match(hub_gene_data_sorted$external_gene_name, names(module_membership_list))
]
module_network_colors <- module_colors[seq_along(order_left)]
module_membership_norm <- module_membership_norm[
  rownames(module_membership_norm) %in% rownames(module_membership), , drop = FALSE
]
module_membership_norm <- module_membership_norm[
  match(hub_gene_data_sorted$external_gene_name, rownames(module_membership_norm)), , drop = FALSE
]

V(graph)$pie.color = list(module_network_colors)
V(graph)$vertex.shape <- "pie"
V(graph)$vertex.color <- module_membership_list
V(graph)$vertex.label.family = "sans"

module_max_genes <- apply(module_membership_norm, 2, function (x) which(x == max(x)))
module_max_genes <- rownames(module_membership_norm)[unlist(module_max_genes)]
module_max <- vector()
for (l in seq(length(V(graph)))) {
  if (V(graph)[l]$name %in% module_max_genes) {
    module_max <- append(module_max, "yes")
  } else {
    module_max <- append(module_max, "no")
  }
}

unique_markers <- gene_anno[gene_anno$ensembl_gene_id %in% rownames(results_sig), ]
DE <- vector()
for (l in seq(length(V(graph)))) {
  if (V(graph)[l]$name %in% unique_markers$external_gene_name) {
    DE <- append(DE, "yes")
  } else if (V(graph)[l]$name %in% open_targets$symbol) {
    DE <- append(DE, "maybe")
  } else {
    DE <- append(DE, "no")
  }
}

# V(graph) <- V(graph)[DE == "yes"]

direction <- vector()
for (l in seq(length(E(graph)))) {
  hub_gene_sub <- hub_gene_data[
    hub_gene_data$external_gene_name %in% head_of(graph, l)[[1]]$name,
  ]
  direction <- append(direction, unique(hub_gene_sub$direction))
}
E(graph)$edge.color <- ifelse(direction == "up", "firebrick1", "dodgerblue")

membership <- (abs(rowSums(module_membership_norm)) / hub_gene_all_GO) * abs(rowSums(module_membership_norm))

vertex_frame_color <- data.frame(DE = DE) %>%
  mutate(
    type = case_when(
      DE == "yes" ~ "white",
      TRUE ~ "lightgray"
    )
  )
vertex_frame_color <- vertex_frame_color$type

vertex_label_color <- data.frame(DE = DE) %>%
  mutate(
    type = case_when(
      DE == "yes" ~ "white",
      TRUE ~ "lightgray"
    )
  )
vertex_label_color <- vertex_label_color$type

vertex_label_font <- data.frame(DE = DE) %>%
  mutate(
    type = case_when(
      DE == "yes" ~ 2,
      TRUE ~ 3
    )
  )
vertex_label_font <- vertex_label_font$type

# vertex_label <- data.frame(DE = DE) %>%
#   mutate(
#     type = case_when(
#       TRUE ~ V(graph)$name
#     )
#   )
# vertex_label <- vertex_label$type
# vertex_label[vertex_label == "NA"] <- NA
vertex_label <- data.frame(DE = DE) %>%
  mutate(
    type = case_when(
      DE == "yes" ~ V(graph)$name,
      DE == "maybe" ~ V(graph)$name,
      TRUE ~ NA
    )
  )
vertex_label <- vertex_label$type
vertex_label[vertex_label == "NA"] <- NA

vertex_label_cex <- data.frame(DE = DE) %>%
  mutate(
    type = case_when(
      DE == "yes" ~ 3,
      TRUE ~ 2
    )
  )
vertex_label_cex <- vertex_label_cex$type

hub_score <- hub_gene_data_sorted$hub_score

png(file.path(
  results_dir, paste0("oterogarcia_comb_01genefunnel_network_left.png")), width = 4680, height = 4050, res = 300
)
par(bg = "black", mar = c(0, 0, 0, 8), xpd = TRUE)
jam_igraph(
    graph,
    rescale = FALSE,
    xlim = c(-1, 1),
    ylim = c(-1, 1),
    layout = norm_coords(layout),
    vertex.size = (hub_score + 0.1) * 30,
    vertex.label.color = vertex_label_color,
    edge.width = (E(graph)$weight * 0.8) ^ 3,
    vertex.shape = "pie",
    vertex.pie = module_membership_list,
    edge.color = ifelse(direction == "up", "firebrick1", "dodgerblue"),
    vertex.label.family = "sans",
    vertex.label.font = vertex_label_font,
    vertex.label.cex = ifelse(DE == "yes", 2, 1.25),
    vertex.frame.color = vertex_frame_color,
    vertex.label = vertex_label,
    use_shadowText = TRUE,
    pie_to_jampie = FALSE
)
legend(
    "right",
    legend = paste0(
      "Module ", unique(hub_gene_data$module)
    ),
    pch = 20,
    col = module_network_colors,
    pt.cex = 3,
    cex = 1.5,
    bty = "n",
    text.col = "white",
    y.intersp = 1,
    inset = c(-0.12, 0)
)
dev.off()

hub_gene_right_all <- lapply(hub_gene_list_right_all, function(x) cbind(rowname = rownames(x), x))
hub_gene_right_all <- Reduce(function(x, y) merge(x, y, all = TRUE), hub_gene_right_all)
hub_gene_right <- lapply(hub_gene_list_right, function(x) cbind(rowname = rownames(x), x))
hub_gene_right <- Reduce(function(x, y) merge(x, y, all = TRUE), hub_gene_right)

hub_gene_data <- vector()
for (l in seq_along(order_right)) {
  module_sets <- rownames(mat_right)[order_right[[l]]]

  # module_gene_sets_sub <- gene_sets[names(gene_sets) %in% modules_down]

  frequent_genes <- vector()

  module_gene_sets_sub <- gene_sets[names(gene_sets) %in% module_sets]
  frequent_genes_tmp <- as.data.frame(table(unlist(geneIds(module_gene_sets_sub))))
  frequent_genes_tmp <- frequent_genes_tmp[
    frequent_genes_tmp$Var1 %in% gene_anno$ensembl_gene_id,
  ]
  rownames(frequent_genes_tmp) <- NULL
  if (any(frequent_genes_tmp$Var1 %in% rownames(results_left))) {
    discard <- which(
      frequent_genes_tmp$Var1 %in% rownames(results_left)
    )
    if (length(discard) > 0) {
      frequent_genes_tmp <- frequent_genes_tmp[-discard, ]
    }
  }
  frequent_genes <- frequent_genes_tmp

  # module_gene_sets_sub <- gene_sets[names(gene_sets) %in% module_sets]
  node_data <- reshape2::melt(geneIds(module_gene_sets_sub))
  node_data <- node_data[node_data$value %in% frequent_genes$Var1, ]
  names(node_data) <- c("ensembl_gene_id", "gene_set")
  gene_anno_sub <- gene_anno[
    gene_anno$ensembl_gene_id %in% node_data$ensembl_gene_id,
  ]
  node_data <- node_data[node_data$ensembl_gene_id %in% gene_anno_sub$ensembl_gene_id, ]
  node_data <- left_join(node_data, gene_anno_sub, by = "ensembl_gene_id")
  node_data$direction <- "up"
  node_data$DE <- ifelse(
    node_data$ensembl_gene_id %in% rownames(results_sig), "yes", "no"
  )
  node_data <- node_data[node_data$ensembl_gene_id %in% hub_gene_right_all$Var1, ]
  # node_data <- node_data[node_data$DE == "yes", ]
  node_data$module <- l
  node_data$hub <- ifelse(
    node_data$ensembl_gene_id %in% unlist(top_genes_right_all), "yes", "no"
  )
  node_data$top_gse <- ifelse(
    node_data$gene_set %in% unname(unlist(top_gse_right)), "yes", "no"
  )
  # node_data <- node_data[node_data$external_gene_name %in% open_targets$symbol, ]
  # node_data <- node_data[node_data$top_gse == "yes", ]
  node_data <- node_data[node_data$hub == "yes" | node_data$external_gene_name %in% open_targets_all$symbol, ]
  hub_gene_data <- rbind(hub_gene_data, node_data)
}

# hub_gene_data <- hub_gene_data[hub_gene_data$DE == "yes", ]

unique_direction <- as.data.frame.matrix(table(hub_gene_data[ , c(3, 4)]), )
unique_direction$up <- unique_direction$up * 1
discard <- which(rowSums(unique_direction) == 0)
if (length(discard) > 0) {
  unique_direction <- unique_direction[-discard, ]
}
module_membership_norm <- unique_direction
unique_direction <- ifelse(rowSums(unique_direction) > 0, "up", "down")
hub_gene_data <- hub_gene_data[
  hub_gene_data$external_gene_name %in% names(unique_direction),
]

rownames(hub_gene_data) <- NULL
discard <- vector()
for (i_gene in seq_along(hub_gene_data$external_gene_name)) {
  sub_gene <- hub_gene_data$external_gene_name[i_gene]
  sub_unique_direction <- unique_direction[which(names(unique_direction) == sub_gene)]
  if (hub_gene_data$direction[i_gene] != sub_unique_direction[[1]]) {
    discard <- append(discard, i_gene)
  }
}
if (length(discard) > 0) {
  hub_gene_data <- hub_gene_data[-discard, ]
}

frequent_genes_tmp <- as.data.frame(table(hub_gene_data$external_gene_name))
frequent_genes <- frequent_genes_tmp
hub_gene_data <- hub_gene_data[
  hub_gene_data$external_gene_name %in% frequent_genes$Var1,
]

# hub_gene_data <- hub_gene_data[which(hub_gene_data$DE == "yes"), ]

hub_score <- c()
for (i in seq_along(unique(hub_gene_data$module))) {
  hub_gene_data_sub <- hub_gene_data[hub_gene_data$module == i, ]
  hub_gene_sub <- hub_gene_list_right_all[[i]]
  colnames(hub_gene_sub) <- c("ensembl_gene_id", "hub_score")
  hub_gene_data_sub <- left_join(hub_gene_data_sub, hub_gene_sub, by = "ensembl_gene_id")
  if (any(is.na(hub_gene_data_sub$hub_score))) {
    discard <- which(is.na(hub_gene_data_sub$hub_score))
    hub_gene_data_sub <- hub_gene_data_sub[-discard, ]
  }
  # hub_score <- c(hub_score, hub_gene_sub$Freq)
  if (i == 1) {
    hub_gene_data_new <- hub_gene_data_sub
  } else {
    hub_gene_data_new <- rbind(hub_gene_data_new, hub_gene_data_sub)
  }
}
hub_gene_data <- hub_gene_data_new

hub_gene_data_list <- vector("list", length = length(unique(hub_gene_data$module)))
names(hub_gene_data_list) <- unique(hub_gene_data$module)
for (i in seq_along(hub_gene_data_list)) {
  hub_gene_data_sub <- hub_gene_data[hub_gene_data$module %in% names(hub_gene_data_list)[i], ]
  hub_gene_data_sub <- hub_gene_data_sub[hub_gene_data_sub$hub == "yes", ]
  # hub_gene_data_list[[i]] <- quantile(hub_gene_data_sub$hub_score, probs = 0.75)
  hub_gene_data_list[[i]] <- min(hub_gene_data_sub$hub_score)
}

min <- min(unlist(hub_gene_data_list))
keep <- c()
for (i in seq(nrow(hub_gene_data))) {
  gene_set_name <- hub_gene_data$module[i]
  if (hub_gene_data$hub_score[i] >= min) {
    keep <- c(keep, i)
  }
}
# hub_gene_data <- hub_gene_data[keep, ]

# hub_gene_data_list <- vector("list", length = length(unique(hub_gene_data$gene_set)))
# names(hub_gene_data_list) <- unique(hub_gene_data$gene_set)
# for (i in seq_along(hub_gene_data_list)) {
#   hub_gene_data_sub <- hub_gene_data[hub_gene_data$gene_set %in% names(hub_gene_data_list)[i], ]
#   hub_gene_data_list[[i]] <- hub_gene_data_sub$DE
# }
# 
# remove <- which(unlist(lapply(hub_gene_data_list, FUN = function(x) all(x == "no"))))
# if (length(remove) > 0) {
#   remove <- names(hub_gene_data_list)[remove]
#   remove <- which(hub_gene_data$gene_set %in% remove)
#   hub_gene_data <- hub_gene_data[-remove, ]
# }

# hub_gene_data <- hub_gene_data[hub_gene_data$DE == "yes", ]
# hub_gene_data <- hub_gene_data[hub_gene_data$hub_score >= min(hub_gene_data_sub$hub_score), ]
# hub_gene_data <- hub_gene_data[hub_gene_data$hub_score >= 0.00001 | hub_gene_data$DE == "yes", ]

hub_gene_data_sorted <- hub_gene_data[order(hub_gene_data$hub_score, decreasing = TRUE), ]
hub_gene_data_sorted <- hub_gene_data_sorted[-which(duplicated(hub_gene_data_sorted$ensembl_gene_id)), ]
# hub_gene_data_sorted <- hub_gene_data_sorted[match(names(membership), hub_gene_data_sorted$external_gene_name), ]

# hub_score <- hub_gene_data_sorted$hub_score
# names(hub_score) <- names(membership)

hub_mat <- as.data.frame.matrix(table(hub_gene_data[ , c(3, 2)]), )
hub_mat <- hub_mat[match(hub_gene_data_sorted$external_gene_name, rownames(hub_mat)), ]
hub_mat <- hub_mat == 1
co_mat <- hub_mat %*% t(hub_mat)
diag(co_mat) <- 0
graph <- graph_from_adjacency_matrix(co_mat, "upper", TRUE)

edges <- get.edgelist(graph, FALSE)
set.seed(1)
layout <- qgraph.layout.fruchtermanreingold(
  edges, vcount = vcount(graph), weight = E(graph)$weight,
  area = vcount(graph) / 1, repulse.rad = vcount(graph) / 4
)

hub_gene_all_GO <- table(unlist(geneIds(gene_sets)))
hub_gene_all_GO <- hub_gene_all_GO[
  names(hub_gene_all_GO) %in% unique(hub_gene_data$ensembl_gene_id)
]
sub_gene_anno <- gene_anno[gene_anno$ensembl_gene_id %in% rownames(hub_gene_all_GO), ]
rownames(sub_gene_anno) <- NULL
sub_gene_anno <- sub_gene_anno[
  match(rownames(hub_gene_all_GO), sub_gene_anno$ensembl_gene_id),
]
rownames(hub_gene_all_GO) <- sub_gene_anno$external_gene_name
hub_gene_all_GO <- hub_gene_all_GO[match(hub_gene_data_sorted$external_gene_name, names(hub_gene_all_GO))]

module_membership <- as.data.frame.matrix(table(hub_gene_data[ , c(3, 6)]), )
module_membership <- module_membership[match(hub_gene_data_sorted$external_gene_name, rownames(module_membership)), ]
module_membership_binary <- module_membership
module_membership_binary[module_membership_binary > 0] <- 1
module_membership_list <- lapply(
  split(module_membership, row.names(module_membership)), unlist
)
module_membership_list <- module_membership_list[
  match(hub_gene_data_sorted$external_gene_name, names(module_membership_list))
]
module_network_colors <- module_colors[seq_along(order_right)]
module_membership_norm <- module_membership_norm[
  rownames(module_membership_norm) %in% rownames(module_membership), , drop = FALSE
]
module_membership_norm <- module_membership_norm[
  match(hub_gene_data_sorted$external_gene_name, rownames(module_membership_norm)), , drop = FALSE
]

V(graph)$pie.color = list(module_network_colors)
V(graph)$vertex.shape <- "pie"
V(graph)$vertex.color <- module_membership_list
V(graph)$vertex.label.family = "sans"

module_max_genes <- apply(module_membership_norm, 2, function (x) which(x == max(x)))
module_max_genes <- rownames(module_membership_norm)[unlist(module_max_genes)]
module_max <- vector()
for (l in seq(length(V(graph)))) {
  if (V(graph)[l]$name %in% module_max_genes) {
    module_max <- append(module_max, "yes")
  } else {
    module_max <- append(module_max, "no")
  }
}

unique_markers <- gene_anno[gene_anno$ensembl_gene_id %in% rownames(results_sig), ]
DE <- vector()
for (l in seq(length(V(graph)))) {
  if (V(graph)[l]$name %in% unique_markers$external_gene_name) {
    DE <- append(DE, "yes")
  } else if (V(graph)[l]$name %in% open_targets$symbol) {
    DE <- append(DE, "maybe")
  } else {
    DE <- append(DE, "no")
  }
}

# V(graph) <- V(graph)[DE == "yes"]

direction <- vector()
for (l in seq(length(E(graph)))) {
  hub_gene_sub <- hub_gene_data[
    hub_gene_data$external_gene_name %in% head_of(graph, l)[[1]]$name,
  ]
  direction <- append(direction, unique(hub_gene_sub$direction))
}
E(graph)$edge.color <- ifelse(direction == "up", "firebrick1", "dodgerblue")

membership <- (abs(rowSums(module_membership_norm)) / hub_gene_all_GO) * abs(rowSums(module_membership_norm))

vertex_frame_color <- data.frame(DE = DE) %>%
  mutate(
    type = case_when(
      DE == "yes" ~ "white",
      TRUE ~ "lightgray"
    )
  )
vertex_frame_color <- vertex_frame_color$type

vertex_label_color <- data.frame(DE = DE) %>%
  mutate(
    type = case_when(
      DE == "yes" ~ "white",
      TRUE ~ "lightgray"
    )
  )
vertex_label_color <- vertex_label_color$type

vertex_label_font <- data.frame(DE = DE) %>%
  mutate(
    type = case_when(
      DE == "yes" ~ 2,
      TRUE ~ 3
    )
  )
vertex_label_font <- vertex_label_font$type

# vertex_label <- data.frame(DE = DE) %>%
#   mutate(
#     type = case_when(
#       TRUE ~ V(graph)$name
#     )
#   )
# vertex_label <- vertex_label$type
# vertex_label[vertex_label == "NA"] <- NA
vertex_label <- data.frame(DE = DE) %>%
  mutate(
    type = case_when(
      DE == "yes" ~ V(graph)$name,
      DE == "maybe" ~ V(graph)$name,
      TRUE ~ NA
    )
  )
vertex_label <- vertex_label$type
vertex_label[vertex_label == "NA"] <- NA

vertex_label_cex <- data.frame(DE = DE) %>%
  mutate(
    type = case_when(
      DE == "yes" ~ 3,
      TRUE ~ 2
    )
  )
vertex_label_cex <- vertex_label_cex$type

hub_score <- hub_gene_data_sorted$hub_score

png(file.path(
  results_dir, paste0("oterogarcia_comb_01genefunnel_network_right.png")), width = 4680, height = 4050, res = 300
)
par(bg = "black", mar = c(0, 0, 0, 8), xpd = TRUE)
jam_igraph(
    graph,
    rescale = FALSE,
    xlim = c(-1, 1),
    ylim = c(-1, 1),
    layout = norm_coords(layout),
    vertex.size = (hub_score + 0.1) * 30,
    vertex.label.color = vertex_label_color,
    edge.width = (E(graph)$weight * 0.8) ^ 3,
    vertex.shape = "pie",
    vertex.pie = module_membership_list,
    edge.color = ifelse(direction == "up", "firebrick1", "dodgerblue"),
    vertex.label.family = "sans",
    vertex.label.font = vertex_label_font,
    vertex.label.cex = ifelse(DE == "yes", 2, 1.25),
    vertex.frame.color = vertex_frame_color,
    vertex.label = vertex_label,
    use_shadowText = TRUE,
    pie_to_jampie = FALSE
)
legend(
    "right",
    legend = paste0(
      "Module ", unique(hub_gene_data$module)
    ),
    pch = 20,
    col = module_network_colors,
    pt.cex = 3,
    cex = 1.5,
    bty = "n",
    text.col = "white",
    y.intersp = 1,
    inset = c(-0.12, 0)
)
dev.off()
```

```{r, fig.height = 2, fig.width = 5.5}
names(top_genes_left) <- top_words_left_title
gene_ids <- geneIds(gene_sets)
gene_ids <- gene_ids[names(gene_ids) %in% unlist(top_gse_left)]
gene_ids <- gene_ids[match(unlist(top_gse_left), names(gene_ids))]
links_orig <- data.frame(
  source = rep(names(gene_ids), times = lengths(gene_ids)), target = gene_ids %>% map_dfr(as_tibble)
)
map <- setNames(gene_anno$external_gene_name, gene_anno$ensembl_gene_id)
links <- links_orig
links_orig[] <- map[unlist(links_orig)]
links$value <- links_orig$value
colnames(links) <- c("source", "target")
links <- links[links$target %in% unique(sapply(top_genes_left, function(x) names(x)[c(1, 4, 7, 10)])), ]
dup <- which(duplicated(links[ , 1:2]))
if (length(dup) > 0) {
  links <- links[-dup, ]
}
stack <- rbindlist(lapply(top_gse_left, FUN = stack))
stack$ind <- rep(lapply(top_gse_left, function(x) paste(names(x), collapse = " ")), unlist(lapply(top_gse_left, function(x) sum(lengths(x)))))
stack <- stack[stack$values %in% unique(links$source), ]
stack <- stack[ , c(2, 1)]
colnames(stack) <- colnames(links)
links_orig <- links
links <- rbind(links, stack)
value <- c()
for (target in stack$target) {
  value <- c(value, length(which(links_orig$source %in% target)))
}
links$value <- c(rep(1, times = nrow(links_orig)), value)
nodes <- data.frame(name = c(as.character(links$source), as.character(links$target)) %>% unique())
links$IDsource <- match(links$source, nodes$name) - 1
links$IDtarget <- match(links$target, nodes$name) - 1
sankeyNetwork(
  Links = links, Nodes = nodes, Source = "IDsource", Target = "IDtarget",
  Value = "value", NodeID = "name", sinksRight = FALSE, fontSize = 20
)

names(top_genes_right) <- top_words_right_title
gene_ids <- geneIds(gene_sets)
gene_ids <- gene_ids[names(gene_ids) %in% unlist(top_gse_right)]
gene_ids <- gene_ids[match(unlist(top_gse_right), names(gene_ids))]
links_orig <- data.frame(
  source = rep(names(gene_ids), times = lengths(gene_ids)), target = gene_ids %>% map_dfr(as_tibble)
)
map <- setNames(gene_anno$external_gene_name, gene_anno$ensembl_gene_id)
links <- links_orig
links_orig[] <- map[unlist(links_orig)]
links$value <- links_orig$value
colnames(links) <- c("source", "target")
links <- links[links$target %in% unique(sapply(top_genes_right, function(x) names(x)[c(1, 4, 7, 10)])), ]
dup <- which(duplicated(links[ , 1:2]))
if (length(dup) > 0) {
  links <- links[-dup, ]
}
stack <- rbindlist(lapply(top_gse_right, FUN = stack))
stack$ind <- rep(lapply(top_gse_right, function(x) paste(names(x), collapse = " ")), unlist(lapply(top_gse_right, function(x) sum(lengths(x)))))
stack <- stack[stack$values %in% unique(links$source), ]
stack <- stack[ , c(2, 1)]
colnames(stack) <- colnames(links)
links_orig <- links
links <- rbind(links, stack)
value <- c()
for (target in stack$target) {
  value <- c(value, length(which(links_orig$source %in% target)))
}
links$value <- c(rep(1, times = nrow(links_orig)), value)
nodes <- data.frame(name = c(as.character(links$source), as.character(links$target)) %>% unique())
links$IDsource <- match(links$source, nodes$name) - 1
links$IDtarget <- match(links$target, nodes$name) - 1
sankeyNetwork(
  Links = links, Nodes = nodes, Source = "IDsource", Target = "IDtarget",
  Value = "value", NodeID = "name", sinksRight = FALSE, fontSize = 20
)
```

```{r, fig.height = 5, fig.width = 7}
names(top_genes_left) <- top_words_left_title
gene_ids <- geneIds(gene_sets)
gene_ids <- gene_ids[names(gene_ids) %in% unlist(top_gse_left_all)]
gene_ids <- gene_ids[match(unlist(top_gse_left_all), names(gene_ids))]
links_orig <- data.frame(
  source = rep(names(gene_ids), times = lengths(gene_ids)), target = gene_ids %>% map_dfr(as_tibble)
)
map <- setNames(gene_anno$external_gene_name, gene_anno$ensembl_gene_id)
links <- links_orig
links_orig[] <- map[unlist(links_orig)]
links$value <- links_orig$value
colnames(links) <- c("source", "target")
links <- links[links$target %in% unique(sapply(top_genes_left, function(x) names(x)[c(1, 4, 7, 10)])), ]
dup <- which(duplicated(links[ , 1:2]))
if (length(dup) > 0) {
  links <- links[-dup, ]
}
stack <- rbindlist(lapply(top_gse_left_all, FUN = stack))
stack$ind <- rep(lapply(top_gse_left_all, function(x) paste(names(x), collapse = " ")), unlist(lapply(top_gse_left_all, function(x) sum(lengths(x)))))
stack <- stack[stack$values %in% unique(links$source), ]
stack <- stack[ , c(2, 1)]
colnames(stack) <- colnames(links)
links_orig <- links
links <- rbind(links, stack)
value <- c()
for (target in stack$target) {
  value <- c(value, length(which(links_orig$source %in% target)))
}
links$value <- c(rep(1, times = nrow(links_orig)), value)
nodes <- data.frame(name = c(as.character(links$source), as.character(links$target)) %>% unique())
links$IDsource <- match(links$source, nodes$name) - 1
links$IDtarget <- match(links$target, nodes$name) - 1
sankeyNetwork(
  Links = links, Nodes = nodes, Source = "IDsource", Target = "IDtarget",
  Value = "value", NodeID = "name", sinksRight = FALSE, fontSize = 20
)

names(top_genes_right) <- top_words_right_title
gene_ids <- geneIds(gene_sets)
gene_ids <- gene_ids[names(gene_ids) %in% unlist(top_gse_right_all)]
gene_ids <- gene_ids[match(unlist(top_gse_right_all), names(gene_ids))]
links_orig <- data.frame(
  source = rep(names(gene_ids), times = lengths(gene_ids)), target = gene_ids %>% map_dfr(as_tibble)
)
map <- setNames(gene_anno$external_gene_name, gene_anno$ensembl_gene_id)
links <- links_orig
links_orig[] <- map[unlist(links_orig)]
links$value <- links_orig$value
colnames(links) <- c("source", "target")
links <- links[links$target %in% unique(sapply(top_genes_right, function(x) names(x)[c(1, 4, 7, 10)])), ]
dup <- which(duplicated(links[ , 1:2]))
if (length(dup) > 0) {
  links <- links[-dup, ]
}
stack <- rbindlist(lapply(top_gse_right_all, FUN = stack))
stack$ind <- rep(lapply(top_gse_right_all, function(x) paste(names(x), collapse = " ")), unlist(lapply(top_gse_right_all, function(x) sum(lengths(x)))))
stack <- stack[stack$values %in% unique(links$source), ]
stack <- stack[ , c(2, 1)]
colnames(stack) <- colnames(links)
links_orig <- links
links <- rbind(links, stack)
value <- c()
for (target in stack$target) {
  value <- c(value, length(which(links_orig$source %in% target)))
}
links$value <- c(rep(1, times = nrow(links_orig)), value)
nodes <- data.frame(name = c(as.character(links$source), as.character(links$target)) %>% unique())
links$IDsource <- match(links$source, nodes$name) - 1
links$IDtarget <- match(links$target, nodes$name) - 1
sankeyNetwork(
  Links = links, Nodes = nodes, Source = "IDsource", Target = "IDtarget",
  Value = "value", NodeID = "name", sinksRight = FALSE, fontSize = 20
)
```

# References

This is the concluding section of the document. Here we output the `sessionInfo` and create a bibliography for works cited.

```{r}
sessionInfo()
```
